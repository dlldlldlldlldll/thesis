%% CHAPTER 2 (probably)
%% MODELLING and DATA

\chapter{Data and Modelling} %with GEOS-Chem} % Main chapter title
\label{Model} %better reference name?
  
\section{Introduction}
  %Why use models?
  % Models
  
  In this thesis the word model is most often used to represent a chemical transport model (CTM), which simulates chemistry and chemical transport through the atmosphere.
  Models of the atmosphere can be used to interpret measurements, estimate chemical concentrations at any scale, and predict atmospheric composition in the future.
  In remote sensing measurements, modelling is required in order to produce useful outputs.
  Models of ozone in the atmosphere are used broadly for international assessments of ozone precursor emissions, and estimating effects from related processes (such as radiation) \parencite{Young2018}.
  %\textcite{Young2018} summarise current global ozone modelling standards and the metrics and processes used to evaluate these models.
  Models provide an estimate of many trace gas concentrations, however verification is required, and generally performed using results from measurement campaigns.
  In situ measurements from campaigns or measurement stations can be used to examine what is happening at a particular location.
  These data are used to determine how accurate models or estimates are - however the utility is limited to where and when the measurements took place.
  In this thesis data from several campaigns are compared against model outputs and satellite datasets.
  %Satellite usage and reduction of uncertainty
  Satellite datasets provide large amounts of data over most of the planet.
  However, they can have high uncertainty due to instrument limitations.
  Many datapoints can be averaged in order to reduce uncertainty.
  In this chapter several satellite datasets are combined to estimate biogenic HCHO amounts over Australia.
  
  The first goal is to analyse Australia-specific HCHO concentrations measured by satellite, and determine isoprene sensitivity and any model bias.
  This leads into chapter \ref{BioIsop} where biogenic HCHO columns are used to estimate isoprene emissions.
  The second goal is to quantify ozone transported from the stratosphere down into the troposphere (Chapter \ref{Ozone}).
  The focus in this chapter is to describe and analyse model outputs and measurements along with how they are recalculated and compared.
  Section \ref{Model:Datasets} details satellite and campaign datasets, and additionally describes model outputs.
  Measurement techniques used to retrieve the most utilised satellite dataset are outlined in Section \ref{Model:omhcho}.
  Section \ref{Model:GC} describes the GEOS-Chem model, how it is run and what setup and outputs are used in this thesis.
  In Section \ref{Model:AMF} the process of using model outputs to recalculate satellite vertical columns is defined and analysed.
  In order to compare satellite data with other datasets, some work must be undertaken to avoid introducing bias \parencite[e.g.,][]{Palmer2001, Eskes2003, Marais2012, Lamsal2014}.
  One key step is to recalculate the satellite information using modelled data, detailed in section \ref{Model:omiRecalc}.
  The effects of these recalculations on satellite HCHO is also examined.
  The creation and effects of filters used to remove non-biogenic influences are described in section \ref{Model:Filter}.
  
  
% put OMHCHO relevant stuff all into 2.3
% ADD MORE DESCRIPTIVE PICTURES TO SATELLITE DESCRIPTIONS

\section{Datasets}
  \label{Model:Datasets}
  
  This section describes the datasets used in this thesis, along with an overview of the measurement techniques used for each.
  This includes modelled output, satellite measurements, and measurement campaigns.
  These datasets serve four purposes: 
  \begin{enumerate}
    \item Model output validation in this chapter
    \item Calculation of biogenic HCHO distribution over Australia in this chapter
    \item Recalculated OMI formaldehyde columns are used as a basis for estimating isoprene emissions in Chapter \ref{BioIsop}
    \item Extrapolation of ozone transport in chapter \ref{Ozone}
  \end{enumerate}
  I will also give details on filtering and interpolations which are undertaken when reading data, as each dataset has its own resolution.
  While I have not made any measurements myself, it is important to understand the techniques used in datasets I have utilised in order to understand possible anomalous datapoints or trends.
  
  
  Uncertainty (or error) is present in each dataset and where possible the causes are explained.
  There are two types of error: systematic and random.
  Arguably the worst of these is systematic error (or bias).
  Bias normally indicates a problem in calculation or instrumentation.
  If the systematic error is known, it can be corrected for by either offsetting data in the opposite direction, or else fixing the cause.
  A proper fix can only be performed if the sources of error are known and there is a way of correcting or bypassing it.
  Random error is often reported as some function of a datasets variance, or uncertainty.
  It can be reduced through averaging either spatially or temporally. 
  Temporal and/or spatial averaging decreases uncertainty by a factor of $1/\sqrt{N}$ where N is the number of observations being averaged.
  
  \subsection{Satellite}
  \label{Model:Datasets:satellite}
    % Satellite data product levels
    Satellite data products are generally classed into several categories, level 0 through to level 3. Level 0 products are sensor counts and orbital swath data, level 1B data calibrates and geo-locates the level 0 data. 
    Level 2 products additionally have temporal, spatial, solar, and viewing geometry information, as well as quality flags.
    To create level 2 data slant column density is determined and then translated into vertical column density. 
    Level 3 data is a temporally aggregated subset of level 2 data, for instance monthly or yearly averages.
    
    % Satellites use DOAS for trace gases which we are interested in
    Satellites record near nadir (vertical) reflected spectra between around 250-700~nm split into spectral components at around $0.3$~nm in order to calculate trace gases including O$_3$, NO$_2$, and HCHO \parencite[e.g.,][]{Leue2001}.
    Satellite measurements are generally performed using spectral fitting followed by conversion to vertical column densities.
    %The use of multiple satellites can even be used to detect intradiel concentrations in trace gas columns, as shown in \textcite{Stavrakou2015} using OMI and GOME-2 measurements, which have respective overpass times of 1330 and 0930 LT.
    Several public data servers are available which include products from satellites, including NASAs Earthdata portal (\url{https://earthdata.nasa.gov/}) and the Belgian Institute for Space Aeronomy (IASB-BIRA) Aeronomie site (\url{http://h2co.aeronomie.be/}).
    
    
    Rayleigh and Mie scattering describe two kinds of particle effects on radiation passing through a medium.
    Rayleigh scattering is heavily wavelength dependent, and is the dominant form of scattering from particles up to roughly one tenth of the wavelength of the scattered light.
    Mie scattering more generally involves larger particles, and has less wavelength dependence.
    The effects of scattering are what gives us the information about substances in the atmosphere.
    The different particles and gases in the air have measurable properties seen by remote sensing devices such as a satellite. Although instruments will be more or less sensitive to various properties depending on altitude, radiation, and other parameters \parencite[e.g.,][]{Martin2002}.
    
    Difficulties can arise when aerosols interfere with recorded spectra (e.g., clouds, smoke, dust), however some of these can be detected and filtered out.
    Instruments including MODIS on board the Aqua and Terra satellites are able to determine aerosol optical depth (AOD), a measure of atmospheric scatter and absorbance. 
    An AOD under 0.05 indicates a clear sky, while values of 1 or greater indicate increasingly hazy conditions.
    This is important in order to determine where measurements from other instruments may be compromised by high interference.
    Cloud filtering is performed on several satellite products used in this thesis, due to the uncertainty introduces by cloud interference. 
    This has been seen to introduce a clear-sky bias in monthly averages since measurements do not include cloudy days \parencite{Surl2018}.
    
    Satellite measured AOD requires validation by more accurate ground based instruments like those of AERONET which uses more than 200 sun photometers scattered globally.
    Soon much more satellite data will be available in the form of geostationary satellite measurements \parencite{Kwon2017}.
    %\textcite{Kwon2017} examine simulated geostationary measurements against GEOS-Chem column simulations to determine the most important instrument sensitivities.
    Geostationary satellites can provide temporally rich measurements over an area, as they are not sweeping around the earth but fixed relative to one latitude and longitude.
    
    \subsubsection{Formaldehyde}
      
      OMI spectra are used in several products used in this thesis, including OMHCHO, OMNO2d, and OMAERUVd.
      Satellite based formaldehyde measurements from the OMI instrument on board AURA are stored in the OMHCHO product.
      OMHCHO data is used and modified extensively throughout this thesis, and so is discussed in more detail in Section \ref{Model:omhcho}.
      Calculation of column density and AMF are discussed respectively in sections \ref{Model:omhcho:DOAS} and \ref{Model:omhcho:amf}.
  
    \subsubsection{Nitrogen dioxide}
      \label{Model:Datasets:OMNO2d}
      OMNO2d is a gridded daily level three NO$_2$ product with good satellite pixels averaged into 0.25x0.25$^{\circ}$ horizontally resolved bins.
      An example figure from Jan 29, 2005 is shown in figure \ref{Model:Datasets:OMNO2d:fig_eg_omno2d}, while an average for 2005 (global) is shown in figure \ref{Model:Datasets:OMNO2d:fig_omno2d_2005}.
      OMNO2 pixel resolution is 40~km by 130~km.
      NO$_2$ measured by OMI is used to check whether NO$_2$ is well represented by GEOS-Chem (see section \ref{Model:GC:NOx} for the comparison between this product and GEOS-Chem calculations).
      It is also used to form the anthropogenic influence filter for OMHCHO (See section \ref{Model:Filter:NOx}).
      
      
      \mypic{Figures/OMNO2d_2005m0129.png}{Example of NO$_2$ tropospheric columns taken from the OMNO2d product.}{\label{Model:Datasets:OMNO2d:fig_eg_omno2d}}
      
      \mypic{Figures/OMNO2d_avg2005.png}
      {Average 2005 tropospheric NO$_2$ from OMNO2d with pixels screened for $<30\%$ cloud cover.}
      {\label{Model:Datasets:OMNO2d:fig_omno2d_2005}}
      
      Like other satellite products, OMNO2d is influenced by a priori modelling which is required to convert slant path radiance to vertical columns.
      These models are generally low resolution ($\sim$ 110~km by 110~km), which leads to column smearing and difficulty detecting point sources of high NO emissions \parencite{Goldberg2018}.
      Uncertainty in this product arises mostly from the calculation of the AMF (up to 50\% of total error) \parencite{Lorente2017}.
    
    \subsubsection{Aerosol optical depth}
      \label{Model:Datasets:OMAERUVd}
      
      % smoke aaod outline
      Aerosols in the atmosphere can be seen through their affects on light. 
      Smoke and dust can be seen as an increase in aerosol optical depth (AOD) (see section \ref{Model:omhcho:DOAS}).
      This is due these particles scattering and absorbing UV radiation \parencite{Ahn2008}.
      A data product provided by Earthdata (\url{https://disc.gsfc.nasa.gov/datasets/OMAERUVd_V003/summary}) called OMAERUVd (DOI: 10.5067/Aura/OMI/DATA3003) is used in this thesis. 
      
      
      OMAERUVd provides a useful dataset which allows detection of areas which may be smoke affected.
      The product contains AOD and aerosol absorption optical depths (AAOD) at three wavelengths (354, 388, and 500~nm), along with UV aerosol index (UVAI).
      The OMAERUVd product is level three gridded daily data, based on quality filtered level two swath pixels which are then gridded by averaging.
      The product is most sensitive to error in the form of sub-pixel scale cloud interference, so I select AAOD as the basis for my smoke filter as it is least affected by clouds \parencite{Ahn2008}.
      
      % How I read the AAOD
      In this work AAOD is mapped from 1x1\degr horizontal resolution to 0.25x0.3125\degr using nearest value mapping.
      The AAOD at 500~nm wavelength is used to determine smoke influence, although any of the provided wavelengths would be affected by smoke plumes and could also be used.
      This daily AAOD is compared to a threshold to create a daily smoke filter, any areas with AAOD$>0.03$ are considered to be potentially smoke plume affected (see section \ref{Model:Filter:fire}).
    
    \subsubsection{Active fires}
      \label{Model:Datasets:MOD14A1}
      MOD14A1 is a gridded daily satellite based dataset of fire counts at 1x1~km$^2$ horizontal resolution.
      Fire observations are performed four times daily from Terra (10:30~LT, 22:30~LT) and Aqua (01:30~LT, 13:30~LT).
      The fire pixels are detected based on parameters including apparent pixel temperature and the nearby background temperature.
      The dataset is obtained from NASA Earth Observations (NEO) that is part of the EOS Project Science Office at the NASA Goddard Space Flight Center \url{https://neo.sci.gsfc.nasa.gov/view.php?datasetId=MOD14A1_M_FIRE}.
      This product is downloaded and binned into a lower resolution (using the sum of fire pixels) to create an active fire influence mask (see section \ref{Model:Filter:fire}).
      
    \subsubsection{Carbon monoxide}
      \label{Model:Datasets:AIRS}
      
      In chapter \ref{Ozone}, potential biomass burning plumes are identified using satellite observations of CO from the AIRS (Atmospheric Infra-red Sounder) instrument aboard the Aqua satellite \parencite{AIRS3STD}.
      CO is used as a proxy for biomass burning plumes, and used to qualitatively attribute ozone intrusion events as explained in section \ref{Ozone:WeatherClassifications}.
      This is a separate method of detecting fire influence near specific sites through visual analysis.
      
  
    \subsubsection{Uncertainties}
      
      %Satellite Errors
      While satellite data is effective at covering huge areas (the entire earth) it only exists at a particular time of day, is subject to cloud cover, and generally does not have fine horizontal or vertical resolution.
      Concentrations retrieved by satellites have large uncertainties, which arise in the process of transforming spectra into total column measurements, as well as instrument degradation (satellite instruments are hard to tinker with once they are launched).
      Uncertainty in transforming satellite spectra comes from a range of things, including measurement difficulties introduced by clouds, and instrument sensitivity to particular aerosols \parencite{Millet2006}.
      Many products require analysis of cloud and aerosol properties in order to estimate concentration or total column amounts \parencite{Palmer2001,Palmer2003, Marais2012, Vasilkov2017}.
      The main source of error in satellite retrievals of HCHO are due to instrument detection sensitivities, and calculation of the air mass factor (AMF) which converts slanted light path concentrations into a vertical profile \parencite{Millet2006}.
      % amf agreements between groups, but sensitive to a priori
      Calculations of the AMF performed by different groups tend to agree fairly well, as long as all the a priori and ancillary data is similar.
      Large differences can occur depending on the a priori vertical profile, trace gas concentrations, and cloud properties \parencite{Lorente2017}.
      Choice of RTM and interpolation operations have a relatively small affect compared to the assumed state of the atmosphere, with high structural uncertainty introduced at this stage of AMF calculation - as shown in \textcite{Lorente2017}.
      
      %% Detection limit 
      A common way of reducing satellite uncertainty is through oversampling or temporal averaging.
      This is done frequently for trace gases (which are often near to the detection limit over much of the globe).
      For example: \textcite{Vigouroux2009} reduce the measurement uncertainty (in SCIAMACHY HCHO columns) by at least a factor of 4 through averaging daily over roughly 500km around Saint-Denis, and only using days with at least 20 good measurements.
      Another example of this can be seen in \textcite{Dufour2009}, where monthly averaging is used to decrease the measurements uncertainty at the cost of temporal resolution.
      %They examine HCHO in Europe, which is low; near the detection limit of satellite measurements.
      
      %% SURFACE CONDITIONS AND CLOUDS
      In cloudy, hazy or polluted areas measurements are more difficult to analyse \parencite[e.g.,][]{Palmer2003,Marais2014}.
      Recent work by \textcite{Vasilkov2017} showed that updating how the surface reflectivity is incorporated into satellite measurements can change the retrievals by 50~\% in polluted areas.
      
      
  \subsection{Model datasets}
    
    \subsubsection{GEOS-Chem output}
      
      GEOS-Chem model output is used extensively in this thesis and is discussed in more detail in section \ref{Model:GC}.
      Section \ref{Model:GC:simulations:outputs} specifically describes the model outputs used in this thesis.
      These are generally resolved to 47 vertical levels from the ground up to 0.01~hPa, at 2x2.5\degr horizontal resolution.
    
    \subsubsection{Meteorological reanalysis}
      \label{Model:Datasets:ERAI}
      
      Synoptic scale weather patterns are taken from the European Centre for Medium-range Weather Forecasts (ECMWF) Interim Reanalysis (ERA-I) \parencite{Dee2011}.
      These are used in chapter \ref{Ozone} to determine typical weather systems for stratospheric ozone intrusions.
      The version used was ERA-Interim, which was the most up to date at the time (2016) but has since been superseded by ERA5.
    
    \subsubsection{Surface temperatures}
      The Climate Prediction Center (CPC) provides a product with maximum daily land-surface temperature at 0.5x0.5\degr  horizontal resolution. 
      This data is used to check the correlation between HCHO and temperature at a higher resolution than is provided by GEOS-Chem output.
      A full description of the data can be found at \url{https://www.esrl.noaa.gov/psd/data/gridded/data.cpc.globaltemp.html}.
      CPC Global Temperature data is provided by the NOAA/OAR/ESRL PSD, Boulder, Colorado, USA, from their web site at \url{https://www.esrl.noaa.gov/psd/}.
      An example of one day of land temperature output is shown in figure \ref{Model:Datasets:fig_CPC_EG}.
      
      \mypicw{.5\textwidth}{Figures/CPC_Temperature_EG.png}{CPC daily maximum temperature dataset output for 1, Jan, 2005.}{\label{Model:Datasets:fig_CPC_EG}}
  
  \subsection{Campaign datasets}
  
    In this thesis data from several measurement campaigns are used to examine accuracy of modelled data at specific sites.
    Figure \ref{Model:Datasets:fig_locations} shows the locations of BVOC measurement sites in the top panel, and release sites for ozonesondes in the bottom panel.
    These took place over disparate times, and are in situ measurements which are hard to directly compare against GEOS-Chem output which is averaged over a large horizontal space.
    
    \mypic{Figures/campaigns/campaign_locations.png}{Locations of VOC measurements (top panel) and ozonesonde release sites (bottom panel). Inlaid in top panel is the flight paths over Australia of the HIPPO campaign.}{\label{Model:Datasets:fig_locations}}
    
    The campaign datasets provide three separate time series for brief periods of both isoprene and formaldehyde.
    Figure \ref{Model:Datasets:fig_campaigns_compared} shows these along with the detection limits and also shows isoprene measurements superimposed over a single year.
    It is apparent that more measurements are required to see more than the daily cycles.
    
    
    \mypic{Figures/OMI_link/campaigns_compared.png}{ %
      Top: MUMBA, SPS1, and SPS2 time-series for HCHO (orange) and isoprene (magenta), along with detection limits (dashed).
      Bottom: isoprene measurements superimposed onto a single year.
      }{\label{Model:Datasets:fig_campaigns_compared}}
    

    
    \subsubsection{Measurements of Urban, Marine and Biogenic Air (MUMBA)}
    \label{Model:Datasets:MUMBA}
    
      The MUMBA campaign \parencite{PatonWalsh2017} measured various compound abundances including isoprene, formaldehyde, and ozone from 21 December 2012 to 15 February 2013.
      These measurements took place in Wollongong, 10~m above ground level (40~m above sea level).
      Ozone was measured by Thermo UV absorption with 1-minute time resolution averaged into hourly outputs.
      Isoprene and HCHO were measured by Ionicon Proton-Transfer-Reaction Mass spectrometer (PTR-MS), with a time resolution of 3-minutes, averaged each hour.
      Detection limits varied due to instrument conditions, and are listed in table \ref{Model:Datasets:MUMBA:tab_detectionlimits}.
      The full dataset has been published on PANGAEA (DOI:10.1594/PANGAEA.871982) \parencite{Guerette2018}.
      
      
      \begin{table}
        \caption{Detection limits for MUMBA}
        \begin{tabular}{  l |  l  l  l }
          
          \textbf{Dates} & \textbf{HCHO (ppb)} & \textbf{Isoprene (ppb)} & \textbf{Ozone (ppb)}
          \\ \hline
          21/Dec/2012 - 29/Dec/2012 & 0.205 & 0.003 & 0.5 \\
          29/Dec/2012 - 18/Jan/2013 & 0.105 & 0.005 & 0.5 \\
          19/Jan/2013 - 15/Feb/2013 & 0.186 & 0.003 & 0.5 \\
        \end{tabular}
        \label{Model:Datasets:MUMBA:tab_detectionlimits}
      \end{table}
      
      In this thesis we assume uncertainty in this product is as estimated by \textcite{Dunne2018} at (50\%).
      Although the uncertainty determined through calibration measurements was only 15\% \parencite{Guerette2018}, this does not account for competing trace gas interference (such as furan).
      The readings are re-sampled to hourly averages.
      Measurements below the detection limit are set to half of the detection limit when reading this dataset.
    
    \subsubsection{Sydney Particle Studies (SPS1, SPS2)}
    \label{Model:Datasets:SPS}
      Two trace gas measurement campaigns took place at the Westmead air quality station. %with scientists from CSIRO, OEH, and ANSTO 
      Stage 1 (SPS1) from 5 February to 7 March, 2011 and stage 2 (SPS2) from 16 April to 14 May, 2012.
      Two instruments measured VOC concentrations: a PTR-MS, and a gas chromatographer (GC) with a flame ionisation detector (FID).
      The PTR-MS uses chemical ionisation mass spectrometry and can quantify VOCs at high temporal resolution ($< 1$~s).
      It was calibrated several times per day against HCHO, isoprene, $\alpha$-pinene, and several other VOCs, further measurement specifics can be found in \textcite{Dunne2018}.
      % Dunne 2018 looks like an analysis of VOC readings from the sites
      
      The output lists hourly averaged ppbv concentrations of trace gases based on the mass to charge ratio (m/z), which for isoprene is 69.
      % Sensitivities
      It is possible that other chemicals (such as furan, with the same m/z) interfered with this value, especially at low ambient isoprene concentrations and towards the end of autumn (SPS2) when wood fires start to become frequent \parencite{Guerette2018}.
      The GC-FID analysed samples collected in multi-absorbent tubes, with lower temporal resolution but no interference. 
      Further details for this method can be found in \textcite{Cheng2016}.
      GC-FID data is averaged from 0500-1000~LT, and 1100-1900~LT, while PTR-MS data is averaged hourly.
      This includes significant differences between measurement devices when detecting isoprene, potentially due to interfering compounds in the PTR-MS \parencite{Dunne2018}.
      
      Figure \ref{Model:Datasets:SPS:fig_series} shows isoprene and formaldehyde over the course of these two campaigns, as well as the detection limits (dashed lines), as measured by PTR-MS. 
      In order to compare with GEOS-Chem output (see section \ref{Model:GC}) a daily average and an midday time (13:00-14:00~LT) average are both created from these data.
      In averaging, any measurements below the machine detection limit are set to half of the detection limit, as done in \textcite{Lawson2015}. 
      This should minimise any introduced bias.
      
      \mypic{Figures/campaigns/SPS_Series.png}{
        SPS HCHO (yellow) and isoprene (green) time series, along with detection limits (dashed).
        SPS 1 (left) took place in late summer 2011, while SPS 2 (right) occurred during autumn 2012.
      }
      {\label{Model:Datasets:SPS:fig_series}}
    
    
    
    \subsubsection{Ozonesondes}
    \label{Model:Datasets:ozonesondes}
    
      Ozonesonde data come from the World Ozone and Ultraviolet Data Centre (WOUDC).
      Ozonesondes are weather balloons which measure from the surface to around 35km.
      Ozonesondes provide a high vertical resolution profile of ozone, temperature, pressure, and humidity.
      Generally the instrument will perform 150-300 measurements in the troposphere with ozone mixing ratios quantified by an electrochemical concentration cell (\url{http://www.ndsc.ncep.noaa.gov/organize/protocols/appendix5/}).
      
      Ozonesondes are launched approximately weekly from Melbourne (38$^{\circ}$ S, 145$^{\circ}$ E), Macquarie Island (55$^{\circ}$ S, 159$^{\circ}$ E) and Davis (69$^{\circ}$ S, 78$^{\circ}$ E). 
      Melbourne, a major city with more than 4 million residents \parencite{ABS2016}, may be affected by anthropogenic pollution in the lower troposphere.
      Actual releases are north of the central business district in the Broadmeadows suburb.
      Macquarie Island is in the remote Southern Ocean and unlikely to be affected by any local pollution events.
      Davis (on the coast of Antarctica) is also unlikely to experience the effects of anthropogenic pollution.
      More information on this dataset is given in section \ref{Ozone:DataMethods}.
    
    
    \subsubsection{Uncertainties}
    \label{Model:Datasets:uncertainties}
      
      % Measurement difficulties
      In situ measurements contain errors, and depending on the device used and chemical being measured this error can be significant.
      The major sources of uncertainty in measurement techniques included interference from non-target compounds and under-reporting \parencite[e.g.,][]{Dunne2018,Guerette2018}.
      Overall isoprene uncertainty in measurements analysed by \textcite{Dunne2018} was a factor of 1.5 to 2.
      This can feed into uncertainties in modelling and satellite retrievals, as verification and correlations are affected.

\section{Satellite formaldehyde}
\label{Model:omhcho}
  
  % Aura satellite trace gas measurements
  One satellite product used extensively in this thesis is named OMHCHO: from NASA's Earth Observing System's ``Aura'', which provides several other useful datasets (products).
  Aura orbits the earth in a polar sun-synchronous pattern, circling the earth on a plane coincident with the sun and the poles.
  % omi instrument on board aura
  Aura houses the Ozone Monitoring Instrument (OMI), a near-UV/Visible Charged Coupled Device (CCD) spectrometer.
  The OMI instrument on board AURA has been active since July 2005, it records spectra from 264-504~nm using an array of 60 detectors with mid-resolution (0.4-0.6~nm).
  This band of wavelengths allows measurements of trace gases (among other quantities) and the formaldehyde product is detailed here.
  
  
  From here on the word pixel is used to describe one data point retrieved by OMI, each pixel includes a latitude and longitude within OMI's data product.
  Figure \ref{LR:HCHO:Sat:fig_Shenkeveld_OMI_summary} shows the details of OMI's detector array and measurement resolutions.
  OMI measures atmospheric trace gases including NO$_2$, SO$_2$, BrO, HCHO, O$_3$, and aerosols.
  OMI measurements occur from right to left on a band covering 115$^{\circ}$, resulting in swaths of around 2600~km, with pixel sizes from 13x24~km$^2$ at nadir to 26x135~km$^2$ at the swath edges \parencite{Abad2015}.
  The swaths cover Earth daily, both on the light and dark side of the planet, only daytime measurements provide useful near-UV/Visible information.
  
  
  \begin{figure}
    \includegraphics[width=\textwidth]{Figures/Shenkeveld_OMI_summary.png}
    \caption{ %
      Figure 1 and Table 1 from \textcite{Schenkeveld2017}, with the following caption ``An impression of OMI flying over the Earth.
      The spectrum of a ground pixel is projected on the wavelength dimension of the charge-coupled device (CCD; the columns). 
      The cross-track ground pixels are projected on the swath dimension of the CCD (the rows).
      The forward speed of 7~kms$^{-1}$ and an exposure time of 2~s lead to a ground pixel size of 13~km in the flight direction.
      The viewing angle of 114\degr leads to a swath width on the ground of 2600~km.''
      The table shows the optical properties for OMIs three channels.}
    \label{LR:HCHO:Sat:fig_Shenkeveld_OMI_summary}
  \end{figure}
  
  % How omi gets its AMF
  The latest OMHCHO algorithm uses a shape factor determined from GEOS-Chem using 47 vertical levels at monthly temporal resolution and 2$^{\circ}$ latitude by 2.5$^{\circ}$ longitude horizontal resolution \parencite{Abad2015}.
  The GEOS-Chem model has been substantially updated since then
  In this thesis the more recent version $V10.01$ is used to recalculate the vertical column HCHO (details are shown in section \ref{Model:omiRecalc}).
  
  OMI uses a Differential Optical Absorption Spectroscopy (DOAS) based technique to read HCHO along the path of light which reaches the satellite instrument.
  The first step is to determine how much HCHO is in the path of light between the sun and detector.
  Measurements done using DOAS often apply a forward radiative transfer model (RTM) such as LIDORT (see section \ref{Model:Meas:sat:LIDORT}) in order to determine a trace gas' radiative properties at various altitudes.
  The forward RTM used for satellite data products also involve functions representing extinction from Mie and Rayleigh scattering, and the effect of these on spectra.
  These RTM are also required to account for (often estimated) atmospheric parameters such as albedo.
  The next step is to transform the calculated amounts along the non-vertical light path into vertical column amounts.
  This is done by applying an AMF.
  In the absence of atmospheric scattering a simple geometric AMF can be defined as a function of the solar zenith angle. 
  The solar zenith angle ($\theta_s$) and the satellite viewing angle ($\theta_v$) are shown in image \ref{ch_HCHO:fig:zenithangle}.
  However, in the UV-VIS region of the spectrum, Rayleigh and Mie scattering (see section \ref{Model:omhcho:DOAS}) must be accounted for.
  
  
  \begin{figure}\begin{center}
      \includegraphics[width=0.6\textwidth]{Figures/ZenithAngles.png}
      \caption{Solar and viewing zenith angles, image copied from \textcite{SZA_Image}, originally from a NASA website.}
      \label{ch_HCHO:fig:zenithangle}
    \end{center}\end{figure}
  
  % How omhcho is produced
  Atmospheric HCHO detected by satellite requires that other trace gases with similar features near the HCHO affected wavelengths are accounted for.
  A DOAS fit determines the total column amount of a trace gas along the path that the instrument views.
  This uses the Beer-Lambert law where radiance is reduced as light travels through a medium.
  I use the NASA OMHCHOv003 data product \parencite{Abad2015}, with HCHO determined using the spectral window $328.5$~nm$ - 356.5$~nm. 
  The algorithm used is based on direct fitting of radiances, and accounts for competing absorbers, under-sampling, and Ring effects.
  An OMI radiance measurement over the remote Pacific ocean is used instead of an irradiance measurement.
  This means that the slant columns ($\Omega_S$) are formed from the spectra differential with respect to the radiance reference column over the Pacific.
  The full method details for slant column retrieval by OMI are outlined in supplemental section \ref{SuppNotes:Satellite:OMI_BOAS}, or in the technical document (DOI: 10.5067/Aura/OMI/DATA2015).
  Slant columns range from $\sim 4\times 10^{15} $ to $\sim 6 \times 10^{16}$~molec cm$^{-2}$, with uncertainties from 30\% (larger columns) to over 100\% (smaller columns) \parencite{Abad2015}.
  
  \subsection{Pixel filtering}
  \label{Model:omhcho:pixel_filtering}
  
  % What the swathes look like
  This thesis uses the level 2 product swath output from the NASA earth data web portal.
  OMHCHO level two data includes 14-15 daily swaths of measurements.
  Each swath contains roughly $9 \times 10^4$ pixels, each of which includes latitude, longitude vertical column HCHO, along with all the ancillary data required to make the vertical column and several data quality metrics.
  The OMHCHO dataset has a quality flag which can be used to remove unlikely or poor satellite measurements.
  The states represented by this quality flag are shown in table \ref{Model:Datasets:OMHCHO:tab_qflag} which is taken from \textcite{Kurosu2014}.
  Filtering bad or missing measurement pixels is performed prior to any other filtering, this includes the datapoints affected by the row anomaly.
  This anomaly \parencite{rowanomaly_url} affects radiance data at particular viewing angles, corresponding to a row on the CCD detectors, and is dynamic over time.
  The slant columns affected are flagged and removed before any further processing.
  
  
  \begin{table}
    \caption{OMI quality flag values table from \textcite{Kurosu2014}}
    \begin{tabular}{  l  l  p{10cm} }
      \hline
      \textbf{Value} & \textbf{Classification} & \textbf{Rational} 
      \\ \hline
      0 & Good & Column value present and passes all quality checks; data may be used with confidence. 
      \\ \hline
      1 & Suspect & Caution advised because one or more of the following conditions are present: 
      \begin{itemize}
        \item Fit convergence flag is $<$ 300 but $>$ 0: Convergence at noise level
        \item Column $+ 2 \sigma$ uncertainty $<$ 0 $<$ Column $ + 3 \sigma $ uncertainty
        \item Absolute column value $>$ Maximum column amount (1e19 molec cm$^{-2}$)
      \end{itemize}
      \\ \hline
      2 & Bad & Avoid using as one of the following conditions are present: 
      \begin{itemize}
        \item Fit convergence flag is $<$ 0 : No convergence, abnormal termination
        \item Column $+ 3 \sigma$ uncertainty $<$ 0
      \end{itemize}
      \\ \hline
      $<0$ & Missing & No column values have been computed; entries are missing
      \\ \hline
    \end{tabular}
    \label{Model:Datasets:OMHCHO:tab_qflag}
  \end{table}
  
  Each $\sim90$ minutes the AURA satellite sweeps over the sunny side of the planet of which around 50~k -- 80~k of the roughly 90~k pixels are classified as good.
  Each pixel contains several important pieces of data which are needed for recalculation of the HCHO vertical column: the total column of HCHO ($\Omega$; \moleccm), cloud fraction, associated shape factor, AMF, geometric AMF, scattering weights and their vertical altitudes (hPa), viewing zenith angle, solar zenith angle, latitude, longitude, OMI sensor track, main data quality flag, cross track flag, and total column uncertainty.
  All of these data are needed in order to reconstruct the total vertical column using a modelled a priori shape factor rather than NASA's included a priori shape factor.
  Each pixel includes an estimate of the cloud fraction created using the OMI cloud product OMCLDO2.
  If greater than 40\% of a pixel measurement is cloudy (ie. cloud fraction $>0.4$) then the pixel is removed from subsequent analysis.
  This removes around 30\% of the pixels which remain after filtering out the bad or missing data.
  
  One more filter is applied before any calculations, to remove unreasonable column amounts.
  Due to numerous highly negative vertical columns (beyond what is expected) a screen is applied to remove any pixels with vertical columns outside the range of -5$\times 10^{15}$ to 1$\times 10^{17}$.
  This has been performed previously in TODO %TODO: find which paper did this.
  
  \subsection{DOAS}
    \label{Model:omhcho:DOAS}
    
    The DOAS technique uses solar radiation absorption spectra to measure trace gases through paths of light.
    % Beer lambert
    Beer's law states
    \begin{equation} \label{Model:omhcho:DOAS:eqn_beerslaw}
    T = I/I_0 = e^{-\tau}
    \end{equation}
    with T being transmittance, $\tau$ being optical depth, and I, I$_0$ being radiant flux received at instrument and emitted at source respectively.
    The Beer-Lambert law of extinction allows spectroscopic measurement of absorbing chemical species (absorbers) in the atmosphere:
    \begin{equation} \label{Model:omhcho:DOAS:eqn_backscatterextinction}
    I_B = I_{B_0} e^{-\tau_s}
    \end{equation}
    where I$_B$, I$_{B_0}$ is backscattered intensity with and without the absorber respectively, and $\tau_s$ is the optical thickness of the absorber along the measured path between source and instrument.
    
    $\tau$ can be described using the scattering and absorption cross section area ($\alpha$, cm$^{2}$) and density ($\eta$, molec cm$^{-3}$) of an absorber as follows:
    \begin{equation} \label{Model:omhcho:DOAS:eqn_tau}
    \tau = \int \alpha(s) \eta(s) \mathrm{d}s
    \end{equation}
    $\tau$ through a medium is the sum of optical thicknesses of each absorber within the measured path (s)
    substituting equation \ref{Model:omhcho:DOAS:eqn_tau} into equation \ref{Model:omhcho:DOAS:eqn_backscatterextinction} leads to
    \begin{equation*}
      I = I_0 \exp { \left( \Sigma_i \int \eta_i \alpha_i ds \right) }
    \end{equation*}
    Where \textit{i} represents a chemical species index, and the integral over ds represents integration over the path from light source to instrument.
    
    % Optical depth through the atmosphere
    Another way of describing optical depth (also called optical thickness) is the natural logarithm of the ratio of incident radiant power to transmitted radiant power through a material (from equation \ref{Model:omhcho:DOAS:eqn_backscatterextinction}).
    In the atmosphere we are interested in the optical depth of various chemical species, and we use incoming solar radiation to determine this.
    The difference between solar radiation at the top of the atmosphere and the earth's surface defines the atmospheric optical depth along the path of observation.
    \begin{equation*}
      \tau = \ln{\frac{\phi_e^i}{\phi_e^t}}
    \end{equation*}
    where $\phi_e^i$ is radiant flux seen at the earth surface, $\phi_e^t$ is the solar radiant flux which arrives at the top of the atmosphere.
    In the atmosphere, optical depth can be due to several factors including scattering, chemical absorbance, and aerosols.
  
  \subsection{Air mass factor (AMF)}
  \label{Model:omhcho:amf}
    % what satellite amfs are, and what they do
    To convert the trace gas profile from a reflected solar radiance column (slanted along the light path) into a purely vertical column requires calculations of an air mass factor (AMF).
    In satellite data, the AMF is typically a scalar value for each horizontal grid point which will equal the ratio of the total vertical column density to the total slant column density.
    This value requires calculations to account for instrument sensitivities to various wavelengths over resolved altitudes, and is unique for each trace gas under consideration.
    An AMF characterises measurement sensitivity to a trace gas at various altitudes \cite[e.g.,]{Palmer2001}.
    \textcite{Lorente2017} show that AMF calculations can be the largest source of uncertainty in satellite measurements.
    Another way of describing AMFs are as measures of how radiance at the top of the atmosphere (TOA) changes with trace gas optical depths at specific altitudes \parencite{Lorente2017}.
    Calculation of the AMF is important as it is multiplied against the estimated slant columns in order to give vertical column amounts.
    
    %how do we get an AMF?
    DOAS column retrievals are an integration of a trace gas over the instruments viewing path, in order to convert this total to a vertically distributed column a few assumptions and estimates are required. 
    The vertical profile of a trace gas is assumed or estimated via a CTM, while its scattering and radiative properties are calculated at prescribed altitudes using an RTM. 
    These properties are combined into a single array called the AMF.
    Two examples of this are GOME-2 (on the MetOp-A satellite) products (\url{http://atmos.caf.dlr.de/gome/product_hcho.html}), and OMI products which respectively use LIDORT combined with IMAGESv2 and GEOS-Chem for processing \parencite{Chance2002, Abad2015}.
    AMFs are unique to each trace gas and due to their complexity and the influence of cloud cover they remain one of the largest error sources in remote sensing of BVOCs \parencite{Palmer2001,Millet2006}).
    \textcite{Lamsal2014} recommends that when comparing satellite data to models, the AMF should first be recalculated using the model as an a priori.
    This is in order to remove any a priori bias between model and satellite columns.
    
    % averaging kernal relation to amf, why amfs are important when comparing data
    Related to the AMF is the averaging kernal (AK), which is used to handle instrument measurements which are sensitive to gas concentrations at different altitudes through the atmosphere.
    DOAS methods can be heavily influenced by the initial estimates of a trace gas profile (the a priori) which is often produced by modelling, so when comparing models of these trace gases to satellite measurements extra care needs to be taken to avoid introducing bias from differing a priori assumptions.
    One way to remove these a priori influences is through the satellite AK (or AMF), which takes into account the vertical profile of the modelled trace gas and instrument sensitivity to the trace gas \parencite{Eskes2003, Palmer2001}.
    This process is called deconvolution ($\Omega = AK \times VC_{satellite} + \times (I - AK) VC_{a priori}$) of the AK of the satellite instrument.
    The AK represents sensitivities to each species at multiple altitudes through the atmosphere and in the case of OMI, can be approximated from the scattering weights ($\omega(z)$) function as follows:
    \begin{equation} \label{ch_HCHO:eqn:AKfromw}
    AK(z) = \frac{\omega(z)}{AMF}
    \end{equation}
    This is an approximation for the OMI product, which does not include the AK but does include the $\omega$ and AMF, as explained in \textcite{Abad2015}.
  
  \subsection{LIDORT}
    \label{Model:Meas:sat:LIDORT}
    
    %http://www.rtslidort.com/about_publications.html
    LIDORT is a model of LInearized Discrete Ordinate Radiative Transfer, used to determine backscatter intensities and weighting functions at arbitrary elevation angles \parencite{Spurr2001}.
    The model solves radiative transfer equations and can be used to determine various atmospheric column measurement attributes such as optical depth, ring effects, and scattering.
    These radiative properties (or at least estimates thereof) are required when measuring trace gases in the atmosphere through a long path such as seen by satellites \parencite[e.g.,][]{Palmer2001,Martin2002a,DeSmedt2015,Abad2015}.
  
  \subsection{Uncertainty}
    Uncertainty in a single pixel for OMHCHO is roughly the same magnitude as HCHO background levels.
    Each pixel has $\sim 2 \times 10^{14}$\moleccm uncertainty, which is $5 \times$ higher than GOME.
    However, there are $\sim 100-200 \times $ as many measurements allowing a greater reduction of uncertainty with averaging.
    This is due to the smaller footprint and better temporal resolution of OMI \parencite{Chance2002,Millet2008}.
    % Uncertainty in OMI pixels measurements
    The finer nadir resolution of OMI (13 by 24~km${^2}$) compared to other satellites also reduces cloud influence \parencite{Millet2006, Millet2008}.
    The top row in figure \ref{Model:Meas:sat:fig_OMI_uncertainty} shows OMI HCHO columns binned to at 0.25\degr longitude by 0.3125\degr latitude averaged over one day and one month (with and without filtering).
    Row two shows uncertainty of the satellite data after averaging.
    It is clear that one day of satellite data is too uncertain when binned at 0.25x0.3125\degr horizontal resolution, however after a month (with or without filtering) the uncertainties become manageable.
    If we assume the uncertainty is random error, and not bias introduced through calculation techniques, then we are able to reduce the uncertainty through averaging.
    High resolution low detection limit estimates can be built up using ``oversampling'', which averages satellite measurements over time \parencite[e.g.,][]{Zhu2014}.
    Uncertainty in satellite recalculations, along with other factors is analysed in section \ref{BioIsop:Uncertainty}.
    %A good example can be seen in \textcite{Zhu2014} where 0.2$^{\circ}$ by 0.2$^{\circ}$ resolution with high enough sensitivity to see anthropogenic HCHO is acheived with three summers worth of satellite data.
    
    % Figure from tests.py
    \mypic{Figures/OMI_link/Uncertainty_OMI_200501.png}{Top row shows 0.25\degr by 0.3125\degr binned OMHCHO columns with one day, one month, and one month with non-biogenic masking applied from left to right respectively. Bottom row shows the uncertainty for each gridsquare after averaging.}{\label{Model:Meas:sat:fig_OMI_uncertainty}}
    
    In this thesis, HCHO columns (pixels) with cloud fractions over 40\% are filtered as done in \textcite{Palmer2001}, which introduces a clear-sky bias to any monthly averages.
    This is due to HCHO being lower on unrecorded cloudy days.
    This bias has been measured as a 13\% positive monthly mean bias \parencite{Palmer2001, Surl2018}.
    
    
    % Row anomaly
    Recently \textcite{Schenkeveld2017} analysed the performance over time of the instrument and found irradiance degradation of 3-8\%, changed radiances of 1-2\%, and a stable wavelength calibration within 0.005-0.020~nm.
    These changes are measured excluding the row anomaly (RA) effect, which is relatively stable since 2011, although it is still growing and remains the most serious concern.
    Their analysis of OMI concludes that data is still of high quality and will deliver useful information for 5-10 more years, with radiance only changing by $1-2\%$ outside of RA impacted areas.
    An analysis of the row anomaly by \textcite{Huang2017} state that measurements remain suitable for scientific use, with recommendation for further evaluation.
    % they were talking about ozone columns...
    The RA began in June 2007, with some cross-track rows seemingly blocked. 
    The most likely cause is some instrument insulation partially obscuring the radiance port \parencite{Schenkeveld2017}.
    
    %% BACKGROUND MEASUREMENTS
    In satellite HCHO products, concentrations over the remote pacific ocean are sometimes used to analyse faulty instrument readings.
    This is due to the expected invariance of HCHO over this region.
    For instance GOME (an instrument which measures trace gases on board the ERS-2) corrects for an instrument artefact using modelled HCHO over the remote pacific \parencite{Shim2005}.
    OMI HCHO products use a similar technique to account for sensor plate drift and changing bromine sensitivity \parencite{Abad2015}.
    Uncertainty in the OMI satellite instrument is calculated by the Smithsonian Astrophysical Observatory (SAO) group using the uncertainty in backscattered radiation retrievals \parencite{Abad2015, Abad2016}.
    Another method of calculating the uncertainty is used by the Belgian Institute for Space Aeronomy (BIRA) group, who determine uncertainty from the standard deviation of HCHO over the remote pacific ocean \parencite{DeSmedt2012, DeSmedt2015}.
    
    %% LOW BIAS IN SATELLITE HCHO EXAMPLES
    For many places the tropospheric column HCHO measured by satellite is biased low, \textcite{Zhu2016} examine six available datasets and show a bias of 20 - 51\% over south east USA when compared against a campaign of aircraft observations (SEAC$^4$RS).
    \textcite{DeSmedt2015} also found OMI and GOME2 observations were 20 - 40\% lower than ground based vertical profiles, and \textcite{Barkley2013} determine OMI to be 37\% low compared with aircraft measurements over Guyana.
    These bias can be corrected by improving the assumed a priori HCHO profiles which are used to calculate the AMFs of the satellite columns.
    \textcite{Millet2006} examine OMI HCHO columns over North America and determine overall uncertainty to be 40\%, with most of this coming from cloud interference.
    \textcite{Millet2008} shows that there also exists some latitude based bias, as well as a systematic offset between the OMI and GOME instruments.
    This does not appear to be due to the different overpass times of the two instruments.
    
    %A full analysis of the AMF uncertainty in OMI measurements, as well as the structural uncertainty (between different systems of calculations applied to the same data) is performed by \textcite{Lorente2017}.
    AMF calculation often dominates the total uncertainty in satellite retrievals, especially in polluted regions \parencite{Lorente2017}.
    In scenarios where the gas is enhanced in the lower troposphere, AMF calculation is the largest uncertainty in satellite measurements.
    In polluted environments the structural uncertainty is estimated at 42~\%, or 31~\% over unpolluted environments \parencite{Lorente2017}.
    Another impact often not included in uncertainty calculations is the structural uncertainty of retrieval methods.
    The structural uncertainty of AMF calculation approaches used by different retrieval groups comes from how the AMF is calculated, rather than uncertainty in the calculation components.
    The importance of a priori and ancillary data (such as surface albedo and cloud top height) sharply affects the structural uncertainty \parencite{Lorente2017}.
    
\section{GEOS-Chem}
  \label{Model:GC}

  \subsection{Overview}
    % Geos chem is a box model with chemistry and meteorology
    GEOS-Chem is a well supported global, Eulerian CTM (see section \ref{LR:Models:ctm}) with a state of the science chemical mechanism, with transport driven by meteorological input from the Goddard Earth Observing System (GEOS) of the NASA Global Modeling and Assimilation Office (GMAO).
    Chemistry, transport, and meteorology are simulated at 15 minute time steps within a global set of 3-D boxes.
    Emissions are either prescribed by inventories or modelled (e.g., biogenic emissions are created using the Model of Emissions of Gases and Aerosols from Nature (MEGAN)).
    % It uses GEOS, from GMAO
    
    % This thesis uses 10.01 at 2x2.5 model output
    GEOS-Chem simulates more than 100 chemical species from the earth's surface up to the edge of space (0.01~hPa) and can be used in combination with remote and in situ sensing data to give a verifiable estimate of atmospheric gases and aerosols.
    It was developed, and is maintained, by Harvard University staff as well as users and researchers worldwide.
    In this thesis I use version 10.01 of GEOS-Chem, which outputs up to 66 chemical species (tracers) in the standard run, at 2 by 2.5$^{\circ}$ horizontal resolution, with 47 levels up to the top of the atmosphere (TOA at 0.01~hPa). 
    
    
    Global CTMs are often run using one or several emission models (or the output from them) to determine boundary conditions.
    Some of the inventories used by GEOS-Chem are described here.
    Meteorological fields are taken from NASA's GEOS-5 dataset (0.5\degr x 0.666\degr) \parencite{Chen2009}, which exists up to April 2013.
    GEOS-5 meteorological fields are used as the boundary conditions driving transport.
    % Emissions models used for boundary conditions
    Fire emissions come from the global fire emissions database (GFED4) product \parencite{Giglio2013}. 
    Anthropogenic VOC emissions come from the Emission Database for Global Atmospheric Research (EDGAR) inventory, while biogenic VOC emissions are simulated using the MEGAN model (see section \ref{Model:GC:MEGAN}).
    MEGAN is used to determine biogenic emissions for our default GEOS-Chem simulation.
    The estimated biogenic VOC emissions are important for accurately simulating chemistry within models, as discussed in Section \ref{LR:Atmos:Chem}.
    
  
  \subsection{Installing and running GEOS-Chem}
    \label{Model:GC:running}
    GEOS-Chem instructions for download, compilation, and running can be found in the user guide provided by Harvard: \url{http://acmg.seas.harvard.edu/geos/doc/man/}.
    In order to build and run GEOS-Chem a high-speed computing system is optimal, as globally gridded chemical calculations can take a long time to perform (for us $\sim 70$ computation hours per month).
    I installed GEOS-Chem onto a suitably configured workspace on the Raijin supercomputer at the National Computational Infrastructure (NCI, \url{http://nci.org.au/}).
    This workspace included access to compilers and libraries which are needed to build the Fortran based GEOS-Chem source code, and IDL, Python, and various editors and scripting languages to read, run, edit, and analyse both GEOS-Chem and its output.
    After downloading GEOS-Chem, the code can be compiled with different options for resolution and chemical mechanisms.
  
  %UP TO HERE JENNY FEEDBACK 
  \subsection{Chemical Mechanism}
    \label{Model:GC:Mechanisms}
    A chemical mechanism is the name for a closed system of chemical reactions and the rates of each reaction.
    Chemical reactions are represented by systems of differential equations to be solved for each gridbox in GEOS-Chem.
    Simplifications are required due to the massive amount of reactions which occur in the atmosphere, and the coupled and stiff nature of these reactions which serve to slow down computation of the solutions \parencite{BrasseurJacob2017}.
    Stiffness in chemical systems of differential equations is due to the massively differing reaction rate time scales - for instance hydroxyl radicals react within seconds while methane has an atmospheric lifetime of 8-10 years \parencite{Wuebbles2002}. 
    
    Some of the important reactions involving isoprene are reproduced here, including reaction rates (k) in the form $ k = A \exp{-ER/T}$, where T is temperature, TODO find definition again.
    Equation \ref{Model:GC:Mechanisms:eqn_mechanisms} lists the main isoprene and sundry reactions, with terms defined in \ref{Model:GC:Mechanisms:tab_species}.
    Some tracers are defined in order to allow the model to keep track of extra information such as the tracers source.
    For instance LISOPOH keeps track of how isoprene lost to OH reactions.
    The full current mechanism is described online at \url{http://wiki.seas.harvard.edu/geos-chem/index.php/New_isoprene_scheme}.
    
    %globchem.dat in the run directory.
    % species in http://wiki.seas.harvard.edu/geos-chem/index.php/Species_in_GEOS-Chem#Aerosol-only
    %Isoprene is ISOP. 
    %% LISOPOH is isop lost to OH reactions
    %% RIO2 is the isoprene peroxy radical ISOPOO
    %% INO2 is a class of products formed from Isop and NO3
    %% ISOPNB is ISOPN-beta
    %% ISOPNBO2 is ISOPNB+OH products
    %% ISNP is an ISOPN 
    %% PRPE are >C3 alkenes (C3H6, ...)
    % first line shows reaction rate:
    %     A nnn <A> xxxExx <-ER>  xxx  xx  xx
    %  k  =    <A>  exp {<-ER>/T}
    % T is Temperature
    \begin{align} \begin{split}
    \label{Model:GC:Mechanisms:eqn_mechanisms}
    \ce{
      % A 587 Isop oxidation by OH
      ISOP + OH ->[3.1*10^{-11} \exp{(350/T})] & RIO2 (+LISOPOH) \\ 
      % A606 Isoprene ozonolysis
      ISOP + O3 ->[1*10^{-14} \exp{(-1970/T})] & 0.244MVK + .325MACR + \highlight{0.845HCHO} \\
        & + .11H2O2 + .522CO + .204HCOOH \\
        & + .199MCO3 +.026HO2 + .27OH \\
        & + .128PRPE + .051MO2 \\ 
      % A621 Isoprene NO3 oxidation
      ISOP + NO3 ->[3.3*10^{-12} \exp{(-450/T)}] & INO2 \\
      % products from ISOPOO + NO
      RIO2 ->[4.07*10^{8} \exp{(-7694/T)}] & 2HO2 + \highlight{HCHO} + .5MGLY + .5GLYC \\
        & + .5GLYX + .5HAC + OH \\
      RIO2 + NO ->[2.7*10^{-12} \exp{(350/T)}] & .883NO2 + .783HO2 + \highlight{.66HCHO} \\
        & + .4MVK + .26MACR + .07ISOPND \\
        & + .123HC5 + .1DIBOO + .047ISOPNB \\
      RIO2 + HO2 ->[2.91*10^{-13} \exp{(1300/T)}] & .88RIP + .12OH + .047 MACR \\
        & + .073MVK + .12HO2 + \highlight{.12HCHO} \\
      RIO2 + MO2 ->[8.37*10^{-14}] & 1.1HO2 + \highlight{1.22HCHO} + .28MVK \\
        & + .18MACR + .3HC5 + .24MOH + .24ROH \\
      RIO2 + RIO2 -> [1.54*10^{-13}] & 1.28HO2 + \highlight{.92HCHO} + .56MVK + \\
        & .36MACR + .48ROH + .5HC5 \\
      RIO2 + MCO3 -> [1.68*10^{-12} \exp{(500/T)}] & .887HO2 + \highlight{.747HCHO} + .453MVK \\
        & +.294MACR + .14HC5 + .113DIBOO \\
        & + CO2 + MO2 
    }
    %     % k1=2.7*10^{-12} \exp{350/T}
    %     % k2=4.07*10^{8} \exp{-7694/T}
    %      
    \end{split} \end{align}
    
    TODO: Finish this table after finishing above meechanisms
    \begin{table}
      \caption{Species or classes from the GEOS-Chem mechanism.}
      \begin{tabular}{ c l }
        \textbf{Name} & \textbf{Definition} 
        \\ \hline
        GLYC & Glycoaldehyde: HOCH2CHO \\
        GLYX & Glyoxal: CHOCHO \\
        HAC & Hydroxyacetone: HOCH2C(O)CH3 \\
        INO2   &  RO2 from ISOP+NO3    \\  
        ISOPNB  &   $\beta$ isoprene nitrates     \\
        ISOPND  &   $\delta$ isoprene nitrates    \\
        ISNP & an isoprene nitrate \\
        MACR & Methacrolein: CH2=C(CH3)CHO \\
        MGLY & Methylglyoxyal: CH3COCHO \\
        MVK & Methylvinylketone: CH2=CHC(=O)CH3 \\
        PRPE & >C3 alkenes: C3H6, ... \\
        RIO2 & isoprene peroxy radical   \\
        ROH & >C2 alcohols \\
      \end{tabular}
      \label{Model:GC:Mechanisms:tab_species}
    \end{table}
    
  \subsection{GEOS-Chem isoprene modelling}
    \label{Model:GC:Isop}
    
    The isoprene reactions simulated by GEOS-Chem were originally based on \textcite{Horowitz1998}.
    This involved simulating NO$_X$, O$_3$, and NMHC chemistry in the troposphere at continental scale in three dimensions, with detailed NMHC chemistry with isoprene reactions and products.
    The mechanism was subsequently updated by \textcite{Mao2013}, who change the isoprene nitrates yields and add products based on current understanding as laid out in \textcite{Paulot2009a, Paulot2009b}.
    Further mechanistic properties, like isomerisation rates, are based on results from four publications: \parencite{Peeters2009, Peeters2010, Crounse2011, Crounse2012}.
    % Peeters looks at OH adduction and subsequent pathways to reform OH with ~ 80% efficiency overall
    
    % hpald: hydroperoxyenal, hydroperoxyaldehyde, hydroperoxy-methyl-butenals
    \textcite{Crounse2011} examines the isomerisations associated with the oxidation of isoprene to six different isomers of ISOPOO formed in the presence of oxygen through $ISOP + OH \to ISOPOO$.
    They determine rates and uncertainties involved in these reactions, and study the rate of formation of C$_5$-hydroperoxyenals (C5-HPALD) by isomerisation.
    Prior to 2012 oxidation chamber studies were performed in high NO or HO$_2$ concentrations, giving peroxy lifetimes of less than 0.1~s \parencite{Crounse2012,Wolfe2012}.
    In most environments NO and HO$_2$ concentrations are not so high, GEOS-Chem uses production rates for different NO concentrations and peroxy radical lifetimes determined by \textcite{Crounse2012}.
    OH regeneration through photolysis of HPALDs in areas with high isoprene emissions are included from \textcite{Peeters2010}.
    Photolysis of photolabile peroxy-acid-aldehydes creates OH and improved model agreement with continental observations.
    OH and HPALD interactions are central to maintaining the OH levels in pristine and moderately polluted environments, which makes isoprene both a source and a sink of OH \parencite{Peeters2010,Taraborrelli2012}.
    
    Formation of isoprene nitrates (ISOPN) have an effect on ozone levels through NO$_X$ sequestration, and the yields and destinies of these nitrates is analysed in \textcite{Paulot2009a}.
    %% ISOPN can be oxidised (by OH) to form nitrated organic products \parencite{Paulot2009a}.
    In a chamber with clean air and high NO concentrations, isoprene photooxidation is initially driven by OH addition, followed by NO$_X$ chemistry (150~min - 600~min), and finally HO$_X$ dominated chemistry.
    GEOS-Chem uses these the yields of various positional isomers of isoprene nitrates, and pathways of their oxidation products, and reactions within its suite of chemical mechanisms determined by \textcite{Paulot2009a,Mao2013}.
    %They use anion chemical ionization mass spectrometry (CIMS) to determine products of isoprene photooxidation.
    
    % First steps in GC: LOW NOx
    GEOS-Chem models both high and low NO$_X$ scenarios using NO$_X$ dependent reactions as derived by \textcite{Paulot2009a,Mao2013}.
    In low NO$_X$ ISOPOO reacts with HO$_2$ ($70\%$ yield of hydroxy hydroperoxides, ISOPOOH), RO$_2$ (producing mainly MACR, MVK, and HCHO), or isomerises (1,5-H shift producing MACR, MVK, HCHO, or 1,6-H shift producing HPALDs). 
    ISOPOOH can be oxidised (by OH) to produce epoxydiols (IEPOX), recycling OH \parencite{Paulot2009b}. 
    HPALDs can photolyse to regenerate OH and small VOCs \parencite{Crounse2011,Wolfe2012, Peeters2014}.
    Under low NO$_X$ conditions production of HCHO , MVK, and MACR is 4.7\%, 7.3\%, and 12\% respectively.
    Refer to section \ref{LR:VOCs:IsopCascade} for more information.
    % High nox chemistry
    Under high NO$_X$ conditions, isoprene undergoes OH addition at the 1 and 4 positions, becoming $\beta$ (71\%) or $\delta$ (29\%) hydroxyl peroxy radicals (ISOPO$_2$). 
    The $\beta$-hydroxyl reacts with NO$_X$ and produces HCHO (66\%), methylvinylketone (40\%) (MVK), methacrolein (26\%), and $\beta$-hydroxyl nitrates (6.7\%) (ISOPNB).
    The $\delta$-hydroxyl reacts with NO to form $\delta$-hydroxyl nitrates (24\%) (ISOPND), and ISOPNB (6.7\%).
    ISOPNB and ISOPND yield first generation isoprene at 4.7\% and 7\% respectively.
    
    % Improvements 
    The isoprene mechanism in GEOS-Chem includes OH regeneration from oxidation of epoxydiols and slow isomerisation of ISOPO$_2$ \parencite{Mao2013}.
    In older models isoprene produced ISOPOOH which then titrated OH, however, the loss of OH had not been seen in measurements \parencite{Paulot2009b,Mao2013}.
    \textcite{Mao2013} show that a lower (factor of 50) rate constant for ISOPO$_2$ isomerisation leads to better organic nitrate aggreements with ICARTT. 
    The chemistry updates have led to more accurate modelling of OH concentrations, especially in low NO$_X$ conditions common in remote forests.
    Prior to \textcite{Mao2012}, measurements of OH in high VOC regions may have been up to double the real atmospheric OH levels, due to formation of OH inside the instrument.    
    The updates to isoprene chemistry by \textcite{Mao2013}, and those shown in \textcite{Crounse2011,Crounse2012} are the last before version 11.  

  
  
  \subsection{Emissions from MEGAN}
    \label{Model:GC:MEGAN}

    MEGAN is a global model with resolution of around 1~km, and is used to generate the BVOC emissions used in various global chemistry models such as GEOS-Chem.
    MEGAN uses leaf area index, global meteorological data, and plant functional types (PFTs) to simulate terrestrial isoprene emissions.
    The model includes global measurements of leaf area index, plant functional type, and photosynthetic photon flux density, from remote sensing databases \parencite{Kefauver2014}.
    The various PFTs are used to generate emission factors which represent quantities of a compound released to the atmosphere through an associated activity.
    For example, the emission factor for isoprene is tied to available sunshine, suitable temperature, etc.
    The schematic for MEGAN, taken from \textcite{Megan_Website}, is shown in figure \ref{Models:GC:Isop:MEGAN:fig_megan_schematic}
    
    \begin{figure}
      \includegraphics[width=\textwidth]{Figures/MEGANmodel_img.jpg}
      \caption{MEGAN schematic, copied from \textcite{Megan_Website}}
      \label{Models:GC:Isop:MEGAN:fig_megan_schematic}
    \end{figure}
    
    GEOS-Chem V10.01 uses MEGAN V2.1 with biogenic emissions from \textcite{Guenther2012}.
    It computes some emissions using predefined EF maps from MEGAN source code, and others using PFT maps and associated EFs.
    MEGAN ``is a modelling framework for estimating fluxes of biogenic compounds between terrestrial ecosystems and the atmosphere to account for the major known processes controlling biogenic emissions'' \parencite{Guenther2012}.
    It allows parameterisation of various BVOC emissions, with descriptions given in \textcite{Guenther2012}.
    
    MEGAN was developed as a replacement for two earlier canopy-environment emission models (BIES and GEIA), and initially included a simple canopy radiative transfer model, which parameterised sun-lit and shaded conditions through a canopy.
    Early models did not account for abiotic stresses, such as drought, prior rainfall and development processes. These stresses influenced species-specific emissions by more than an order of magnitude \parencite{Niinemets1999}.
    Isoprene emissions were based on temperature, leaf area, and light, but have since been updated to include leaf age activity \parencite{Guenther2000}, and a leaf energy balance model \parencite{Guenther2006} in MEGANv2.0.
    This update included a parameter for soil moisture, to account for drought conditions, however this parameter is currently (as of version 2.1) not applied to isoprene \parencite{Sindelarova2014}.
    Soil moisture effects on isoprene emission are important, and can affect estimates.
    
    Instructions to run version 2.1 are available at \url{http://lar.wsu.edu/megan/docs/MEGAN2.1_User_GuideWSU.pdf}, and a version using the Community Land Model (CLM) is available at \url{http://www.cesm.ucar.edu}.
    It uses meteorological fields from the Weather Research and Forecasting (WRF) modelling system.
    Version 2.1 (updated from 2.0 \parencite{Guenther2006}) includes 147 species, in 19 BVOC classes, which can be lumped together to provide appropriate output for mechanisms in various chemical models.
  
  \subsection{Rescaling NOx}
  \label{Model:GC:NOx}
    NO$_X$ concentrations affect atmospheric oxidative capacity, which changes many factors important in estimating isoprene emissions including isoprene to HCHO yield, isoprene lifetime, and isoprene oxidation pathways.
    This means that if the model is poorly simulating NO$_X$, yields and the effects of transport may be poorly estimated.
    In order to determine if re-scaling the NO emissions over Australia is necessary in GEOS-Chem, modelled NO$_2$ amounts are compared to satellite data for most of 2005.
    
    % Geos chem vs tropno2 from omno2d
    Simulated GEOS-Chem tropospheric NO$_2$ columns averaged from 1300-1400~LT are compared against OMNO2d data. %(Sec. \ref{Model:Datasets:OMNO2d}). 
    Figure \ref{Model:Analysis:NOx:fig_GC_vs_OMNO2d_summer_2005} shows the direct comparison between these datasets averaged over the months of January and February, 2005.
    The top row shows (from left to right) GEOS-Chem NO$_2$, OMI NO$_2$ at 0.25x0.3125\degr, and OMI NO$_2$ at 2x2.5\degr.
    The bottom row shows the difference (absolute, and relative) between GEOS-Chem and OMI, as well as the RMA linear correlation.
    The OMNO2d product shows Sydney and Melbourne as NO$_2$ hotspots, which are underestimated by GEOS-Chem due to averaging over the 2x2.5\degr horizontal resolution.
    Over much of the country GEOS-Chem overestimates NO$_2$ by 10-60\%, except in NA and northern Queensland where up to 50\% underestimation occurs.
    The comparison is repeated for winter (JJA) of 2005 in Figure \ref{Model:Analysis:NOx:fig_GC_vs_OMNO2d_winter_2005}.
    
    \begin{figure}
      % Figure from GC_tests.py GC_vs_OMNO2d, then modified in paint
      % Summer correlation
      \includegraphics[width=\textwidth]{Figures/OMI_link/GC/GC_vs_OMNO2_AUS_20050101-20050228.png}
      \caption{%
        Row 1 shows the tropospheric columns in molec cm$^{-2}$, GEOS-Chem, OMNO2d, and OMNO2d averaged onto the lower resolution of GEOS-Chem from left to right.
        Row 2 shows the correlations of GEOS-Chem (X axes) between daily anthropogenic emissions, and mid-day OMNO2d columns.
        Row 3 shows the differences with OMNO2d columns averaged into the lower resolution of GEOS-Chem.
      }
      \label{Model:Analysis:NOx:fig_GC_vs_OMNO2d_summer_2005}
    \end{figure}
    
    \begin{figure}
      % Figure from GC_tests.py GC_vs_OMNO2d, then modified in paint
      % Winter correlation
      \includegraphics[width=\textwidth]{Figures/OMI_link/GC/GC_vs_OMNO2_AUS_20050601-20050831.png}
      \caption{%
        As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMNO2d_summer_2005}, for winter 2005.
      }
      \label{Model:Analysis:NOx:fig_GC_vs_OMNO2d_winter_2005}
    \end{figure}
    
    This comparison is expanded, including against modelled emissions, and repeated for autumn (MAM), winter (JJA), and spring (SON) in figures \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum} to \ref{Model:Analysis:NOx:fig_GC_vs_OMI_soil_Spr}.
    These show an analysis of GEOS-Chem NO emissions and their correlations with the bias between GEOS-Chem NO$_2$ mid-day columns and the OMNO2d product, averaged over each season in 2005.
    The scatter plots have one datapoint for each land square over Australia.
    The correlation between the bias (GEOS-Chem - OMNO2d) with anthropogenic or soil emissions ($E_{NO}$) is shown in the bottom right of these figures.    
    The correlation between model and satellite NO$_2$ columns is OK throughout the year over Australia, with some overestimation in the north during non-summer months.
    There is also slight underestimation over Sydney and Melbourne throughout the year.
    These figures show the visible biases are not driven by modelled emissions of NO.
    While the correlation between column NO$_2$ and emitted NO is clear, emissions do not appear to bias the model in either direction away from the satellite data.
    The poor correlations for anthropogenic NO suggest that blanket alterations over Australia would not lead to improved NO$_2$ fit. 
    
    % Figures from GC_tests.py GCe_vs_OMNO2d
    \mypic{Figures/OMI_link/GC/GCanthro_vs_OMNO2_AUS_20050101-20050228.png}
    {
      Top row (left to right): GEOS-Chem NO$_2$ mid-day tropospheric columns, OMNO2d NO$_2$ columns, modelled anthropogenic NO emissions. 
      Second row: absolute and relative difference between GEOS-Chem and OMI NO$_2$ data, and the correlation.
      Third row: correlation between GEOS-Chem tropospheric column NO$_2$ and emitted NO, then between the model-satellite bias and the emissions.
      All correlation plots are coloured by NO emission rates.
    }
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}}
    
    \mypic{Figures/OMI_link/GC/GCanthro_vs_OMNO2_AUS_20050301-20050531.png}
    {As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}, for Autumn 2005.}
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Aut}}
    
    \mypic{Figures/OMI_link/GC/GCanthro_vs_OMNO2_AUS_20050601-20050831.png}
    {As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}, for Winter 2005.}
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Win}}
    
    \mypic{Figures/OMI_link/GC/GCanthro_vs_OMNO2_AUS_20050901-20051130.png}
    {As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}, for Spring 2005.}
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Spr}}
    
    % Soil pictures
    \mypic{Figures/OMI_link/GC/GCsoil_vs_OMNO2_AUS_20050101-20050228.png}
    {As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}, except anthropogenic NO emissions are replaced by soil NO emissions.}
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_soil_Sum}}
    
    \mypic{Figures/OMI_link/GC/GCsoil_vs_OMNO2_AUS_20050301-20050531.png}
    {As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}, for Autumn 2005, with soil NO emissions replacing anthropogenic NO emissions.}
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_soil_Aut}}
    
    \mypic{Figures/OMI_link/GC/GCanthro_vs_OMNO2_AUS_20050601-20050831.png}
    {As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}, for Winter 2005, with soil NO emissions replacing anthropogenic NO emissions.}
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_soil_Win}}
    
    \mypic{Figures/OMI_link/GC/GCanthro_vs_OMNO2_AUS_20050901-20051130.png}
    {As figure \ref{Model:Analysis:NOx:fig_GC_vs_OMI_anthro_Sum}, for Spring 2005, with soil NO emissions replacing anthropogenic NO emissions.}
    {\label{Model:Analysis:NOx:fig_GC_vs_OMI_soil_Spr}}
    
    The conclusion drawn is that modelled anthropogenic and soil NO emissions do not show sufficient evidence of biasing GEOS-Chem NO$_2$ columns away from satellite measurements over Australia.
    For this reason modelled NO emissions are not scaled in model runs in this thesis.
  

  \subsection{GEOS-Chem simulations}
    \label{Model:GC:simulations}
    
    GEOS-Chem is run four independent times in this thesis, with different outputs from each simulation used to determine specific information. 
    In this section the different output types are first described (section \ref{Model:GC:simulations:outputs}).
    Following this is the list of model runs, including a summary of the run, which outputs are created, and a summary of how they are used (section \ref{Model:GC:simulations:runs}).
    Finally a brief comparison between a subset of the runs is performed (section \ref{Model:GC:simulations:comparison}).
    
    \subsubsection{GEOS-Chem outputs}
      \label{Model:GC:simulations:outputs}
      There are various outputs available when running GEOS-Chem, some of which require manipulation in order to compare against observations.
      % Default time step and resolution of GC outputs
      GEOS-Chem in this thesis is run with a 15 minute time step for both chemistry and transport, at 2x2.5\degr horizontal resolution over 47 vertical levels.
      Output is the average of these time steps either over an entire month, or else per day, or else for the daily local time window of 1300-1400.
      For example: in this thesis, estimation of model isoprene to HCHO yields uses daily averaged HCHO columns compared against colocated isoprene emissions from MEGAN.
      Optionally one can save high temporally resolved data for a single (or list of) column(s).
      This has been used here to compare modelled ozone with ozonesonde profiles at three sonde release sites discussed in Chapter \ref{Ozone}.
      
      \begin{description}
        \item[Satellite output]%
        is output from averaging over a window of local time for each gridbox. 
        Output averaged between 1300-1400 LT is saved to match with Aura satellite measurements, as Aura overpasses at $\sim$1330 LT each day.
        Satellite output is saved both for comparison with, and recalculation of, satellite measurements.
        %This has been performed by others \parencite[e.g.,][]{Jin2017}.
        \item[HEMCO diagnostics]%
        are output by the HEMCO module, which deals with emissions inventories used in GEOS-Chem.
        % Local time offsets
        When working with globally gridded data, handling local time offsets becomes more important.
        The hourly averaged output emissions of isoprene is saved using GMT, which needs to be offset based on longitude in order to retrieve local time.
        This is done by setting up a latitude by longitude array which matches the horizontal resolution of the data, filling each gridbox with its local time offset.
        This offset is determined as one hour per 15\degr (as 360\degr is 24 hours), and then used to retrieve global data at any specific local time.
        The retrieval of a daily local time global array is done by index matching the GMT+LT (modulo 24) with the desired hour on this grid over the 24 GMT hours.
        % Emissions are averaged over the hour for hemco diag output in biogenic run at least
        \item[Tracer averages]%
        are daily or monthly averaged gridbox concentrations. 
        \item[Time series]%
        list of vertical columns with diagnostics saved at a temporal resolution of up to 15 minutes.
        
        
      \end{description}
    
    \subsubsection{GEOS-Chem runs}
      \label{Model:GC:simulations:runs}
      
      The following list summarises each model run as well as enumerating the outputs (described above), and how the run is used in the thesis.
      \begin{description}
        \item[UCX]%
          Universal tropospheric-stratospheric Chemistry eXtension (UCX) mechanism is run with 72 vertical levels from the surface to the top of the atmosphere (TOA$\sim$0.1~hPa).
          UCX runs a chemistry mechanism with combined tropospheric and stratospheric reactions, with an increased number of stratospheric calculations performed online \parencite{Eastham2014}.
          \begin{enumerate}
            \item Satellite output, daily tracer averages, time series over three stations
            \item Satellite output used to check how shape factors for AMF recalculation are affected by vertical resolution and stratospheric chemistry 
            TODO: Make a plot of AMF with and without 72 vertical levels
            \item Check if the stratospheric chemistry has much influence over tropospheric isoprene or HCHO concentrations.
            \item daily tracer averages are used for ozone intrusion quantification (section \ref{Ozone:fluxcalc}), and ozone seasonality (section \ref{Ozone:ModelComparison}).
            \item Time series are compared against ozonesonde releases (section \ref{Ozone:ModelComparison}) both over time and vertically.
          \end{enumerate}
        
        \item [Tropchem (standard)]%
          default settings for GEOS-Chem 10.01, using 47 vertical levels at 2x2.5\degr horizontal resolution.
          Additional satellite output is created to allow pp code to run on OMI satellite measurements (section \ref{Model:omiRecalc:ppcode}).
        \begin{enumerate}
          \item Satellite output, daily tracer averages, HEMCO diagnostics
          \item Used in recalculation of the satellite AMF (section \ref{Model:AMF}), and the modelled background HCHO over the remote pacific which is used in the reference sector correction for OMI column retrievals (section \ref{Model:omiRecalc:RSC})
          \item Also used to determine isoprene to HCHO yield, after removing days with high biomass burning emissions (section \ref{BioIsop:Method:slope})
          \item Additional satellite outputs used to determine a separate AMF.
          \item Satellite output is combined from two different runs in order to determine smearing (section \ref{BioIsop:Method:Smearing})
          \item HEMCO diagnostics output used to determine isoprene to HCHO yields (section \ref{BioIsop:Calculation:eqn_isop_yield}), and to compare against top-down estimations of isoprene emissions (section \ref{BioIsop:Results:Emissions})
          \item TODO: Compare total yearly ozone concentrations before and after implementing top-down estimate.
        \end{enumerate}
        
        \item [Tropchem (isoprene emissions halved)]%
          identical to standard tropchem except isoprene emissions are halved.
        \begin{enumerate}
          \item Satellite output, monthly tracer averages 
          \item Check modelled ozone sensitivity to isoprene emissions TODO: plot ozone between the two runs and reference here
          \item Combined with standard run to determine model sensitivity transport (section \ref{BioIsop:Method:Smearing})
        \end{enumerate}
        
        \item [Tropchem (biogenic emissions only)]%
          identical to standard tropchem except all non-biogenic emissions inventories are disabled.
        \begin{enumerate}
          \item Satellite output, hourly biogenic emissions from MEGAN
          \item Used to determine the biogenic yield from isoprene to HCHO over Australia, described in section \ref{BioIsop:Methods}
          \item Compared to run with updated emissions (\ref{BioIsop:Results})
        \end{enumerate}
        
        \item [Tropchem (altered MEGAN scaling factor)]
        \begin{enumerate}
          \item Satellite output, time series, daily averaged tracers
          \item Compare to campaign datasets after altering isoprene emissions (see chapter \ref{BioIsop})
          \item Compare against satellite column HCHO as a sanity check on improving isoprene emissions
        \end{enumerate}
        
      \end{description}
    
    
    
    
    \subsubsection{UCX vs tropchem}
      \label{Model:GC:simulations:comparison}
      
      % brief description of both runs resolution
      Here we compare the model output with and without enabling the Universal tropospheric-stratospheric Chemistry eXtension (UCX).
      %From version 11 of GEOS-Chem, the UCX mechanism is enabled by default.
      Both runs use 2$^{\circ}$ latitude by 2.5$^{\circ}$ longitude, however the UCX mechanism is run with 72 vertical levels from the surface to the top of the atmosphere (TOA$\sim$0.1~hPa), while the standard (tropchem) run uses 47 levels.
      The extra vertical levels are added in the stratosphere, providing finer vertical resolution from around 70~hPa to the top of the atmosphere.
      For both runs the input parameters such as MEGAN emissions and GEOS-5 meteorological fields are identical.
      
      % Figure showing differences between runs HCHO described and analysed
      Figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_HCHO_surf_fullday} shows an example of surface HCHO amounts, averaged over Jan and Feb, 2007, with (A) and without (B) UCX turned on.
      Surface HCHO (first model level; up to $\sim$100~m) does not differ much between runs.
      The differences do not exceed 3\% over Australia, and absolute differences are exceedingly minor (note the scale in A-B).
      The major notable difference occurs over northern Africa, where HCHO is around 20\% lower in the UCX run.
      Additionally a slight ($<8\%$) decrease in $\Omega_{HCHO}$ over the oceans can be seen.
      The comparison is repeated using total columns (instead of surface values) in figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_HCHO_totcol_fullday}, showing that differences affecting HCHO between the model run are spread over the entire vertical column.
      
      
      \begin{figure}
        % These figures created in GC_test.py -> UCX_vs_trp...:
        \includegraphics[width=\textwidth]{Figures/OMI_link/GC/UCX_vs_trp_avgsurf_20070101-20070228_hcho.png}
        \caption{%
          Surface HCHO simulated by GEOS-Chem with UCX (top left), and without UCX (top right), along with their absolute and relative differences(bottom left, right respectively).
          Amounts are the average of all times between 1, Jan and 28, Feb, 2007.
        }
        \label{Model:GC:simulations:comparison:fig_UCXvsTrop_HCHO_surf_fullday}
      \end{figure}
      
      \begin{figure}
        % These figures created in GC_test.py -> UCX_vs_trp...:
        \includegraphics[width=\textwidth]{Figures/OMI_link/GC/UCX_vs_trp_avgtotcol_20070101-20070228_hcho.png}
        \caption{%
          As figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_HCHO_surf_fullday} except using total column amounts instead of surface concentrations.
        }
        \label{Model:GC:simulations:comparison:fig_UCXvsTrop_HCHO_totcol_fullday}
      \end{figure}
      

      %TODO Figure showing OH differences..
      % Gc_tests.py -> compare_tc_ucx(...)
      \mypic{Figures/OMI_link/GC/UCX_vs_trp_middaysurf_20070101-20070228_OH.png}{Midday (1300-1400~LT) surface OH concentrations averaged over Jan-Feb, 2007. Absolute and relative differences are shown on the bottom row.}{\label{Model:GC:simulations:comparison:fig_UCXvsTrop_OH_surf_midday}}
      
      % Differences between run isoprene amounts described and analysed here
      Figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_isop_surf_fullday} shows the differences in surface isoprene concentrations over Australia, averaged over 1, Jan to 28, Feb, 2007.
      Here we start to see a higher relative difference in concentrations, although this is generally over the areas with less absolute concentrations. 
      Very little isoprene is seen away from the continents (4-5 orders of magnitude less), due to its short lifetime and  lack of oceanic sources.
      Generally isoprene is 0-30\% higher over mid to western Australia when the UCX mechanism is turned on, however this increase is lower in the regions with high isoprene emissions (north-east to south-east coastline).
      This enhancement can be seen throughout the entire tropospheric column as shown by Figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_isop_surf_fullday}.
      There is a greater effect in Africa and South America in the tropics, with high relative differences in many regions with low absolute amounts.
      
      \begin{figure}
        \includegraphics[width=\textwidth]{Figures/OMI_link/GC/UCX_vs_trp_avgsurf_20070101-20070228_isop.png}
        \caption{ %
          As figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_HCHO_surf_fullday}, except looking at isoprene. 
        }      
        \label{Model:GC:simulations:comparison:fig_UCXvsTrop_isop_surf_fullday}
      \end{figure}
      \begin{figure}
        \includegraphics[width=\textwidth]{Figures/OMI_link/GC/UCX_vs_trp_avgtotcol_20070101-20070228_isop.png}
        \caption{ %
          As figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_isop_surf_fullday}, except looking at isoprene total column amounts. 
        }      
        \label{Model:GC:simulations:comparison:fig_UCXvsTrop_isop_totcol_fullday}
      \end{figure}
      
      
      The difference in isoprene between UCX and tropchem is likely caused by differences in the modelled radiation reaching the troposphere due to differences in simulated ozone in the stratosphere.
      With higher stratospheric ozone levels, less radiation would reach the troposphere, changing the photochemistry.
      Figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_OH_surf_midday} shows how OH at midday is changed between runs.
      This figure shows a marked striping which is due to how OH is handled in GEOS-Chem.
      The most notable difference is again over northern Africa into eastern Europe, with some small decrease in the UCX OH over Australia everywhere except the east coast.
      Figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_O3} shows the total column ozone between UCX and non-UCX runs, using full day averages.
      This shows that UCX ozone is lower everywhere except for a thin band just north and south of the equator.
      Decreased O$_3$ could lead to lower OH and the other differences between the runs over Australia.
      
      
      % TODO: RERUN THIS PLOT
      \begin{figure}
        % Figure from GC_tests.py -> ucx vs tropchem function
        \includegraphics[width=\textwidth]{Figures/OMI_link/GC/UCX_vs_trp_avgsurf_20070101-20070228_O3.png}
        \caption{%
          As figure \ref{Model:GC:simulations:comparison:fig_UCXvsTrop_HCHO_surf_fullday}, except looking at ozone. 
        }
        \label{Model:GC:simulations:comparison:fig_UCXvsTrop_O3_surf_fullday}
      \end{figure}
      
      % Wrap up of UCX vs Tropchem differences and explanation of tropchem usage
      The differences are minimal compared to other uncertainties in both AMF calculation and emissions estimation.
  
  \subsection{Comparisons with campaign data}
          
    Figure \ref{Model:Datasets:SPS:fig_GC_comparison} shows GEOS-Chem output in the gridsquare containing Sydney overlaid on SPS measurement data.
    Superficially the comparison is not too bad between these two datasets, however GEOS-Chem output is the daily average over 2x2.5\degr (latitude by longitude).
    The SPS data is point-source and taken during the daytime when isoprene is higher, so it is very likely that GEOS-Chem HCHO and isoprene output is in fact too high since the daily average should not match the peak of the measurements.
      
    \mypic{Figures/OMI_link/GC_vs_Campaigns_20050131-20050601.png}{Comparison between GEOS-Chem HCHO concentrations in the gridsquare containing Sydney for the duration of the SPS 1 and 2 campaigns}{\label{Model:Datasets:SPS:fig_GC_comparison}}
    
    
    Figure TODO: shows Wollongong FTIR measurement profiles of HCHO with an assumed averaging kernal and then one calculated from GEOS-Chem, along with the two averaging kernal mean and standard deviation.
    TODO: Discuss this conversion and results seen here...
    The bottom panel shows the time series of total column HCHO of both GEOS-Chem and the FTIR instrument in molecules cm$^{-2}$.
    
    % TODO Figure goes here
    
    MUMBA data captured concentration at the surface in Wollongong, and is compared in figure TODO against simulated HCHO concentrations at the first level ($\sim$0 - 150~metres) over corresponding dates. GEOS-Chem midday and day average concentrations are shown, along with Wollongong bottom-level FTIR measurements to compare against the MUMBA data.
    TODO Discussion of comparison.
      
\section{Calculating an AMF}
  \label{Model:AMF}
  
  % What is AMF again?
  The AMF is the ratio of the slant column ($\Omega_s$) to the vertical column ($\Omega_v$)
  \begin{equation} \label{Model:AMF:eqn_AMFFrac}
    AMF=\frac{\Omega_s}{\Omega_v} = \frac{\tau_s}{\tau_v}
  \end{equation}
  with $\tau$ being the optical depth or thickness of the absorber through the slant (\textit{s}) or vertical (\textit{v}) path of light.
  
  
  The OMI instrument records spectra of light which enters the viewing lens on board the Aura satellite.
  The spectra provide backscattered intensity ($I_B$) at various wavelengths (see section \ref{Model:omhcho}), with the light source ($I_{B_0}$) being the sun. 
  Using the log of Beers law (equation \ref{Model:omhcho:DOAS:eqn_beerslaw}) we get 
  $$ \tau_s = \ln{I_{B_0}} - \ln{I_B} $$
  which can be subbed into equation \ref{Model:AMF:eqn_AMFFrac} to give an expression for the AMF which includes scattering:
  \begin{equation} \label{Model:AMF:eqn_amfscattering}
    AMF = \frac{\ln{I_{B_0}}-\ln{I_B}}{\tau_v}
  \end{equation}
  %{Model:omhcho:DOAS:eqn_backscatterextinction}
  %$\tau_s$ is the optical thickness of the absorber along the measured path between source and instrument.
  
  We use $\nabla I = I_B - I_{B_0}$ to represent the change in intensity due to the absorber. 
  For optically thin absorption, $\nabla I / I_B << 1$, and we can use:
  \begin{equation} \label{Model:AMF:eqn_AMFthin}
    AMF = \frac{\ln{ \left( 1 - \frac{\nabla I}{I_B} \right)} }{\tau_v} \approx \frac{ - \frac{\nabla I}{I_B} }{\tau_v}
  \end{equation}
  This is due to the logarithmic property $\ln \left(1-x \right) \approx -x$ for $x<<1$.
  $\nabla I$ can also be expressed as the integral of the absorption slices over optical depth increments: 
  \begin{eqnarray*}
    \nabla I &= \int_0^{\tau_v}{\frac{\partial I_B}{\partial \tau} \mathrm{d}\tau}
    \frac{\nabla I}{I_B} & = \int_0^{\tau_v}{\frac{\partial \ln{I_B}}{\partial \tau} \mathrm{d}\tau}
  \end{eqnarray*}
  which can be placed into equation \ref{Model:AMF:eqn_AMFthin} leading to
  \begin{equation*}
    AMF \approx \frac{-1}{\tau_v} \int_0^{\tau_v}{\frac{\partial \ln{I_B}}{\partial \tau} \mathrm{d}\tau}
  \end{equation*}
  We can then convert $\text{d}\tau$ to our path using equation \ref{Model:omhcho:DOAS:eqn_tau} leading to
  \begin{equation} \label{Model:AMF:eqn_AMFcross}
    AMF = \frac{-1}{\tau_v} \int_0^\infty {\frac{\partial \ln{I_B}}{\partial \tau} \alpha(z)\eta(z)\mathrm{d}z}
  \end{equation}
  where $\alpha(z)$ and $\eta(z)$ represent absorption cross section in m$^2$ molecule$^{-1}$, and number density in molecules m$^{-3}$ respectively. 
  This uses the attenuation cross section relationship to optical depth (see section \ref{Model:omhcho:DOAS}).
  
  To represent an average cross section weighted by the absorbing species' vertical distribution, the effective cross section ($\alpha_e$) is used.
  This is to account for temperature and pressure dependence of $\alpha(z)$, and is defined as:
  \begin{align*}
    \alpha_e &= \frac{1}{\Omega_v} \int_0^\infty \alpha(z) \eta(z) \mathrm{d}z \\
     &= \frac{\tau_v}{\Omega_v}
  \end{align*}
  Then replacing the $\tau_v$ in equation \ref{Model:AMF:eqn_AMFcross} we obtain:
  \begin{equation} \label{Model:AMF:eqn_AMFpreomega}
    AMF=-\int_0^\infty{ \frac{\partial \ln{I_B}}{\partial \tau} \frac{\alpha(z)}{\alpha_e} \frac{\eta(z)}{\Omega_v} \mathrm{d}z }
  \end{equation}
  Often the integrand of this AMF formula (equation \ref{Model:AMF:eqn_AMFpreomega}) is broken apart into two defining terms: the scattering weights $\omega(z)$ and the shape factor $S(z)$, described here:
  \begin{description}
    \item[$\omega$] The scattering weights describing sensitivity of the backscattered spectrum to the abundance of an absorber at altitude z:
    \begin{equation} \label{Model:AMF:eqn_omega}
      \omega(z) = -\frac{1}{AMF_G} \frac{\alpha(z)}{\alpha_e} \frac{\partial \ln{I_B}}{\partial \tau}
    \end{equation}
    It is worth noting that in the OMI satellite product, the provided $\omega(z)$ term does not include the $\frac{1}{AMF_G}$ term and the calculations which follow therefor do not include this term when utilising the provided $\omega$.
    This is not noted in any of the papers which recalculate the AMF from the OMI product, due to them recalculating the $\omega$ term themselves with a radiative transfer model such as LIDORT.
    \item[$S$] the shape factor describes the profile of an absorber ($\eta(z)$) normalised by its total vertical column amount ($\Omega_v$):
    \begin{equation} \label{Model:AMF:eqn_shapefactor}
      S(z) = \frac{\eta(z)}{\Omega_v}
    \end{equation}
  \end{description}
  
  Plugging equations \ref{Model:AMF:eqn_omega} and \ref{Model:AMF:eqn_shapefactor} into equation \ref{Model:AMF:eqn_AMFpreomega} gives us:
  \begin{equation} \label{Model:AMF:eqn_AMF_amfgintwSdz}
    AMF = AMF_G\int_0^\infty{ \omega(z) S(z) \mathrm{d}z}
  \end{equation}
  Since we are using the $\omega$ provided by OMI, the AMF$_G$ term is removed from this calculation as it is not part equation \ref{Model:AMF:eqn_omega} leading to 
  \begin{equation} \label{Model:AMF:eqn_AMF_intwSdz}
    AMF = \int_0^\infty{ \omega(z) S(z) \mathrm{d}z}
  \end{equation}
  
  Additionally the AMF can be determined using the sigma ($\sigma$) coordinate system.
  A conversion to the $\sigma$ vertical coordinate is performed using $P = \sigma (P_S - P_T) + P_T$, where $P_T$ is pressure at the top of the atmosphere and $P_S$ is surface pressure.
  This can be useful when running global atmospheric models as the ground altitude is always at $\sigma=1$ and we need not worry about topography. 
  $S_\sigma$ is a dimensionless normalised shape factor on the $\sigma$ coordinate system.
  In the sigma coordinate system we calculated the shape factor as defined in \textcite{Palmer2001}:
  \begin{equation}
    \label{Model:AMF:eqn_ShapeFactorSigma}
    S_\sigma(\sigma) = \frac{\Omega_a}{\Omega_v}C_{HCHO}(\sigma)
  \end{equation}
  where $\Omega_a$ is the vertical column of air from the surface to the top of the atmosphere and C$_{HCHO}(\sigma)$ is the mixing ratio of HCHO.
  The hydrostatic relation $P = - \rho_a g z$, with $\rho_a$, \textit{g}, being density of air, and gravity respectively lets us integrate over the sigma coordinates:
  \begin{align*}
    \rho_a g z & = \sigma \left( P_S - P_T \right) + P_T \\
    \mathrm{d}\sigma  & = - \frac{ \rho_a g }{ P_S - P_T } \mathrm{d}z
  \end{align*}
  Substitution into \ref{Model:AMF:eqn_AMF_intwSdz} gives AMF using the sigma coordinates:
  \begin{equation} \label{Model:AMF:eqn_AMFintwSdsigma}
    AMF = \int_0^1 w(\sigma) S_\sigma(\sigma) \mathrm{d}\sigma
  \end{equation}

\section{Recalculation of OMI HCHO}
  \label{Model:omiRecalc}
  
  % what is AMF, Omega_V and Omega_S
  The AMF is needed to transform the slant column (SC) viewed by the satellite into a vertical column ($\Omega$):
  \begin{equation}
    \label{Model:omiRecalc:eqn_AMFratio}
    AMF = \frac{SC}{\Omega} %= \frac{\tau_s}{\tau_v}
  \end{equation}
  A slant or vertical column is expressed in molecules cm$^{-2}$.
  % Reiteration of why we recalculate AMFs
  OMI HCHO vertical columns are calculated using modelled a priori HCHO profiles (see section \ref{Model:Datasets:OMHCHO}).
  When comparing satellite measurements against models it is important to recognise the impact of this a priori on the total column values.
  This is complicated by how OMI is differently sensitive to HCHO (and other trace gases) vertically throughout the atmosphere.
  When comparing OMI vertical columns ($\Oo$) to GEOS-Chem ($\Og$), the satellite AMF needs to be recalculated using GEOS-Chem modelled vertical gas profiles as the a prioris.
  Without performing this step a bias between modelled and measured total column values may be due to the a priori rather than chemistry or measurements \parencite{Palmer2001, Lamsal2014}.
  
  % Very brief outline
  Here, two new AMFs are calculated, both using GEOS-Chem HCHO profiles as the new a priori. 
  The first (AMF$_{GC}$) uses the original satellite scattering weights while recalculating the shape factor, whereas the second (AMF$_{PP}$) also recalculates scattering weights.
  AMF$_{PP}$ is created using code initially written by Professor P. Palmer (see sections \ref{Model:omiRecalc:ShapeFactor} and \ref{Model:omiRecalc:ppcode} for more details).
  A reference sector correction is determined using the method described in \textcite{Abad2016}, (see section \ref{Model:omiRecalc:RSC}).
  This correction is unique for each of the 60 \textit{measurement tracks} used by OMI.
  Finally the correction is applied to each pixel to create the corrected vertical column. 
  The end product is three sets of corrected vertical columns: the original ($\Ooc$), one using GEOS-Chem shape factors ($\Ogc$), and one from Palmer's code ($\Opc$).
  
  \subsection{Outline}
    \label{Model:omiRecalc:outline}
    
    % Summary of actual actions taken:
    An outline in computational order of what takes place when recalculating the $\Omega$ from OMI follows:
    \begin{enumerate}
      \item GEOS-Chem satellite overpass output (see section \ref{Model:GC:simulations:outputs}) is used to create new shape factors (S$_z$ and S$_\sigma$).
      \begin{enumerate}
        \item Pressure edges and geometric midpoints are determined, along with altitudes (\textit{z}), and box heights (H).
        \item Number density and mixing ratio of HCHO ($n_{HCHO}$, $C_{HCHO}$ respectively) are taken or created from model outputs HCHO(ppb), air density (molec cm$^{-3}$), and box heights (\textit{H(z)})
        \item Total column HCHO from GEOS-Chem ($\Og$) is calculated $\Og = \Sigma_z \left(n_{HCHO}(z) \times H(z) \right)$, along with total column air ($\Omega_{A}$, calculated similarly)
        \item The shape factor S$_z(z)$ is calculated on each altitude $S_z(z) = n_{HCHO} / \Omega_{HCHO}$.
        \item Pressures (\textit{p})are used to create sigma coordinates $\sigma(z) = (p(z) - p_{TOA}) / (p(0)-p_{TOA})$
        \item S$_\sigma(z)$ is calculated on each altitude: $S_\sigma(z) = C_{HCHO}(z) \times \Omega_A / \Omega_{HCHO}$
      \end{enumerate}
      \item Satellite pixels (SC, scattering weights ($\omega(z)$), pressure levels, latitude and longitude) are read from the OMHCHO dataset
      \item For each pixel, a new AMF (AMF$_{GC}$)is created using the GEOS-Chem shape factors and satellite scattering weights:
      \begin{enumerate}
        \item scattering weights ($\omega$) are interpolated onto the same vertical dimensions (\textit{z} and $\sigma$) as the shape factors.
        \item Integration (approximated using rectangular method) is performed along the vertical dimension to calculate the new AMF on both coordinate systems:
        \begin{align}
          AMF_z &= \Sigma_z \left(\omega(z) \times S_z(z) \times H(z)\right) \\
          AMF_s &= \Sigma_{\sigma} \left(\omega(\sigma) \times S_{\sigma}(\sigma) \times d\sigma \right)
        \end{align}
      \end{enumerate}
      \item These two AMFs represent the same thing using different coordinates, and either one can be used as the AMF$_{GC}$
      \item The AMF$_{PP}$ (created separately) and AMF$_{GC}$ are used to determine the new vertical columns ($\Op$, $\Og$ respectively): $\Omega = SC/AMF$
      \item A reference sector correction (RSC) is defined each day using these AMFs along with modelled HCHO over the remote pacific:
      \begin{enumerate}
        \item GEOS-Chem satellite overpass output ($\Omega_{GEOS-Chem}$ from 140{\degr}W to 160{\degr}W) are averaged monthly and longitudinally to provide a modelled reference sector $\Omega_0[lat]$
        \item The modelled reference slant columns (\textit{MRSC}) are calculated using $MRSC = \Omega_0 \times AMF$ for each AMF
        \item For each satellite pixel between 140{\degr}W and 160{\degr}W, the correction is calculated as the measured \textit{SC} minus the \textit{MRSC} at the nearest latitude:
        \begin{equation*}
          corr[lat,track] = SC[lat,track] - MRSC[lat]
        \end{equation*}
        \item These corrections are binned by satellite detector (track: 1-60), and latitude (0.36\degr; 500 latitudes from 90{\degr}S to 90{\degr}N)
        \item The median entry of each bin is determined and this forms the RSC[lat,track] (e.g., figure \ref{Model:omiRecalc:RSC:fig_track_correction_interpolations})
      \end{enumerate}
      \item VCC are determined using $VCC = (SC - RSC[lat,track] )/AMF$ for each measured SC and using each AMF, with the RSC linearly interpolated to the latitude of the satellite pixel
      \item The VCC (along with most of the pixel and GEOS-Chem data) are binned onto a 0.25\degr by 0.3125\degr grid along with how many pixels have been binned, and the average pixel uncertainty in product OMHCHORP
    \end{enumerate}
 
    
    Figure \ref{Model:omiRecalc:fig_flow_omhchorp} shows an overview of how these profiles are used in this thesis.
    Output from GEOS-Chem is combined with OMHCHO swath data to produce a gridded HCHO file which contains HCHO vertical columns recalculated with GEOS-Chem a prioris.
    PP code is run on a subset of the globe covering Australia and the pacific ocean, producing AMF$_{PP}$.
    The output keeps the original AMF as well as those recalculated using GEOS-Chem (AMF$_{OMI}$, AMF$_{GC}$, and AMF$_{PP}$).
    Additionally, MOD14A1, OMAERUVd and OMNO2d data are used to create masks which are also stored in the OMHCHORP dataset.
    The creation of fire, smoke, and anthropogenic influence masks is described in section \ref{Model:Filter}.
    
    \mypic{Figures/Flow_Making_omhchorp.png}{Flow diagram showing how OMHCHO level two swath data is read, processed, and gridded in this thesis}{\label{Model:omiRecalc:fig_flow_omhchorp}}
      
    
  \subsection{Creating new shape factors}
    % Reminder of AMF -> leading to what is the shapefactor
    In order to visualise and analyse OMI HCHO columns, slant columns are transformed into vertical columns using the AMF.
    The shape factor (\textit{S}) is one of the key components in creation of the AMF (see section \ref{Model:AMF}, equation \ref{Model:AMF:eqn_AMF_intwSdz}).
    The shape factor is calculated using GEOS-Chem satellite output (see section \ref{Model:GC:simulations:outputs}) which provide simulated HCHO concentration profiles ($\eta(z)$) and total columns ($\Omega$) at 2x2.5\degr horizontal resolution.
    Using equation \ref{Model:AMF:eqn_shapefactor} to determine the shape factor is straightforwards $S(z) = \frac{\eta(z)}{\Omega}$.
    The associated OMI per-pixel scattering weights are not changed in this calculation (unlike in section \ref{Model:omiRecalc:ppcode}).
    
    Model output is in molecules per billion molecules of air (ppb), and is converted before being used in the shape factor calculation.
    The following equation converts model profile output from ppb into number densities:
    \begin{equation} \label{Model:omiRecalc:eqn_ppb_to_n}
      \eta_{HCHO} = ppb_{HCHO} \times \eta_a \times 10^{-9}
    \end{equation}
    where $\eta_{HCHO}$ is the number density of a HCHO, $\eta_a$ is the number density of air (from model output), and ppb$_{HCHO}$ is the molecules of that species per billion molecules of air.
    The modelled total vertical column $\Omega_{HCHO}$ is determined by:
    \begin{equation*}
      \Omega_{HCHO} = \Sigma_z \left( \eta_{HCHO} \times H(z) \right)
    \end{equation*}
    where H(z) is the box height for level z.
    In effect this equation sums over the molecules per cm$^2$ in each altitude level.
    
    As a sanity check $S_\sigma$ is calculated (through equation \ref{Model:AMF:eqn_ShapeFactorSigma}) to confirm that these shape factors are equivalent.
    Comparing the resulting AMFs created by equations \ref{Model:AMF:eqn_AMFintwSdsigma} and \ref{Model:AMF:eqn_AMF_intwSdz} for each pixel provides confidence in the unit conversions (and other factors) applied.
    %TODO: Shape factor plot sigma vs z
    For example see figure TODO: plot showing correlation between AMFz and AMFs - or state that these are exactly one to one if that is the case..
    
    %TODO add plot and describe here.
    
    
  \subsection{Reading satellite data}
    
    % Downloading the data
    First satellite slant columns of formaldehyde for the years January 1st, 2005 - April 1st, 2013 are downloaded (see section \ref{Model:Datasets:OMHCHO}).
    The data set used is from the Ozone Monitoring Instrument (OMI) on board the Aura satellite, as it has data for the entire time line and sufficiently covers the southern hemisphere.
    % Filters applied when reading
    When reading OMHCHO level 2 swath files, several factors are taken into account in order to filter uncertain and erroneous pixels.
    The process is outlined in figure  \ref{Model:omiRecalc:fig_flow_omhchorp} for a single day.
    First all \textit{good} pixels (those with QA flag equal to 0) are read into a long list (roughly 1 million per day).
    These are then filtered by solar zenith angle (SZA) and latitude, similarly to other works \parencite[e.g.,]{Marais2012, Barkley2013, Bauwens2016, Zhu2016}.
    This filtering removes highly uncertain pixels, along with those for which instrument problems such as the OMI row anomaly (see section \ref{Model:Datasets:OMHCHO}) may have affected.
    
    % Actual filtering done
    Satellite measurements polewards of 60\degr north or south are removed as well as measurements with SZA greater than 60\degr.
    Pixels with cloud fraction greater than 40\% are removed after being used in determining the reference sector correction (see section \ref{Model:omiRecalc:RSC}), as is done in \textcite{Abad2015, DeSmedt2015}.
    Further filtering is performed to remove the measurements which are most likely to be unrealistic: those with column density outside the range $-0.5 \times 10^{16}$ to $10^{17} $\moleccm, as is performed by\textcite{Zhu2016}.
    This filter is required due to currently unexplained large negative values which occur in the OMI HCHO product increasingly over time.
    Figure \ref{Model:omiRecalc:fig_OMI_negative_hist} shows how unfiltered HCHO columns are affected by a small set of highly negative values which heavily affect the mean column amount over any region.
    The histograms here show the negative (left) and positive (right) total column HCHO measurements from a subset of swaths over Australia, on the 18th of March 2013.
    The highly negative values can be seen around the $-10^{19}$~molecules cm$^{-2}$ region.
    
    \mypic{Figures/AusOMHCHO_Hist_20130318.png}
    {
      Column density histograms for a subset of OMI swaths over Australia on the 18th of March 2013.
      Negative entries are shown in the left panel, positive in the right, note the different scale between negative and positive panels.}
    {\label{Model:omiRecalc:fig_OMI_negative_hist}}
  
    % reading pixels into a long list
    Additional information is added to each pixel, including the new AMFs (see the following subsections).
    Each pixel and its relevant data are saved in a long list for subsequent gridding.
    The shape factors and scattering weights for each pixel lie along a z-axis which is vertically resolved to 47 layers.
  
  % How we get the a priori 
  \subsection{Creating the new AMF}
    \label{Model:omiRecalc:AMFgc}
    
    From equation \ref{Model:AMF:eqn_AMF_intwSdz} we have:
    $$ AMF = \int_0^\infty \omega(z) S(z) \mathrm{d}z $$
    then using the $\omega(z)$ from satellite output, along with our calculated $S_z$ interpolated linearly onto the same vertical grid as $\omega(z)$, the AMF can be determined through integration.
    The integration is performed using a simple rectangular method, which multiplies the integrand midpoints by the change in height, and then takes the sum for each vertical box.
    This assumes that the provided scattering weights and shape factors are linear between the 47 resolved values.
    
  \subsection{Recalculating the AMF using PP code}
    \label{Model:omiRecalc:ppcode}
    % pp code for AMF recalculation referred to as pp code
    
    Some of the pixels (those covering Australia and most of the zonal band) have their AMFs recalculated using Fortran code written by Paul Palmer, and Randal Martin, subsequently updated by Luke Surl.
    I will refer to this as the PP code, and subscript the VCs and AMFs with PP when referring to those calculated through this method.
    Running this code is computationally expensive, and is subset to within the region (50-10\degr~S, 160\degr~W-160\degr~E).
    The code uses a combination of GEOS-Chem a priori profile information and satellite measurement data to calculate the AMF by using LIDORT radiative transfer calculations to determine scattering.
    The instrument sensitivity (or scattering weights; $\omega$) and shape factors for each pixel are calculated within the PP code, which outputs AMF$_{PP}$.
    
    Code for recalculating AMFs using satellite swaths and modelled aerosol optical depths and gas profiles can be found at \url{http://fizz.phys.dal.ca/~atmos/martin/?page_id=129}. 
    The original method for HCHO is layed out in \textcite{Palmer2001}, with modifications for clouds and use of the LIDORT RTM \parencite{Spurr2002} as described by \textcite{Martin2003}.
    This code does not work as is when using OMI satellite data, and requires modifications performed by Luke Surl at Edinburgh University.
    Additionally the tropopause heights averaged within satellite overpass times are required, and provided by modifying the GEOS-Chem diagnostic output.
    
    Mie scattering and clouds can complicate the calculation of $\omega$(z), however tables of values for this function at various parameter inputs can be used with modeled vertical shape factors for local AMF calculations.
    This has been done in the PP code and the AMF look-up-table (LUT) can be found in the source code at (\url{https://github.com/LukeSurl/amf581g}).
    In order to run, output is required from GEOS-Chem: the HCHO concentration profile averaged between 1300 and 1400 LT, including optical depths at 550~nm, and dust concentrations.
    A subset of the OMI pixel information is also required, which is coalesced from OMHCHO daily swath files into csv files (one per day), and read by the PP code in conjunction with the GEOS-Chem outputs for each day.
    The PP code then produces a list of recalculated AMFs which is read by my python code and associated with the corresponding pixel (outlined in \ref{Model:omiRecalc:fig_flow_omhchorp}).
    
    
  \subsection{Vertical columns from AMF}
    
    All that remains for recalculating the total vertical column using our new a priori shape factor is to apply the new AMF to the slant columns and grid them onto our chosen resolution.
    Each satellite pixel at this stage has an associated SC along with three AMFs: the original (AMF$_O$), one with recalculated shape factors (AMF$_G$), and one completely recalculated using PP code (AMF$_{PP}$).
    These are used to create vertical columns ($\Omega$) through equation \ref{Model:AMF:eqn_AMFFrac}: $\Omega = SC/AMF$.
    
    Figure TODO shows a comparison between the three $\Omega$ over Australia for 2005. 
    The first row shows the yearly average column amounts, as well as coloured rectangles describing regions which are averaged over time in row 3.
    Row two from left to right shows the relative differences between $\Op$ and $\Og$, $\Oo$ and $\Og$, and $\Oo$ and $\Op$.
    TODO: Add this plot here.
    
  \subsection{Reference sector correction}
    \label{Model:omiRecalc:RSC}
    % where we apply the RSC
    Each satellite slant column measurement is corrected by its divergence from a modelled reference sector.
    HCHO products from OMI and SCIAMACHY both use a median daily remote pacific ocean radiance reference spectrum, over 15$^{\circ}$S-15$^{\circ}$N, 140$^{\circ}$-160$^{\circ}$W where it is assumed that the only significant source of HCHO is methane oxidation \parencite{DeSmedt2008,Barkley2013,Kurosu2014}.
    
    % What RSC does
    The RSC method corrects for several problems, however it introduces some a priori model influence.
    One of the problems removed through this correction method is instrument degradation, which can introduce bias over time.
    Another is the possible influence of varying dead/hot pixel masks across 2-D detector arrays such as OMI \parencite{DeSmedt2015}.
    This method also corrects for the errors introduced through correlations between BrO and HCHO absorption cross sections, which are especially significant at high latitudes \parencite{Abad2015}.
    
    % How Vertical columns use reference sector corrections
    %Vertical columns in OMI use an oceanic background instead of a solar irradiance spectrum when calculating trace gas interference with DOAS calculations.
    Here a new reference sector correction (\textit{RSC}) is created using modelled and measured HCHO columns over the remote pacific, to produce corrected vertical columns (\textit{VCC}).
    This follows \textcite{Abad2016}, and defines the remote pacific as the band between 140{\degr}W to 160{\degr}W.
    It uses the difference between slant columns ($\Omega_S$) and reference slant columns ($\Omega_{S_0}$) divided by the AMF, plus the modelled reference sector column ($\Omega_{V_B}$):
    \begin{equation*}
      VCC = \frac{ \left( \Omega_S - \Omega_{S_0} \right) }{ AMF } + \Omega_{V_B}
    \end{equation*}
    This method is used in several works, including \textcite[e.g.,][]{DeSmedt2008, DeSmedt2012, DeSmedt2015, Barkley2013, Bauwens2016}.
    Recently this correction was expanded (for OMI data) to include latitudinal and instrument track influence by \textcite{Abad2015}.
    
    % How my RSC is defined
    To get the modelled slant columns, each of the AMFs (calculated in prior sections) is applied to the modelled vertical columns using equation \ref{Model:omiRecalc:eqn_AMFratio}.
    % Then RSC Longitudinally averaged, binned into 500 lats
    The longitudinal average is taken within the remote pacific, as corrections are assumed to be longitudinally invariant.
    The modelled reference sector is averaged over the month and interpolated latitudinally to 500 equidistant bins.
    Figure \ref{Model:omiRecalc:RSC:fig_RSCeg} shows the simulated reference sector VCs as an example, calculated for January 1st 2005.
    In this figure the vertical resolution is increased from 2\degr to 0.36\degr, through linear interpolation, in order to form 500 vertical bins which are used in correcting the satellite data.
    Each day, satellite measurements (pixels) over the remote pacific are used to determine a correction array.
    The model does not produce slant columns associated with each measurement, however one is created by multiplying the vertical column with the associated slant columns AMF.
    
    % This picture was made where?!
    \mypicw{0.7\textwidth}
    {Figures/HCHO/Summary_RSC_Effect8d_20050101.png}
    {%
      Example of remote pacific RSC using 8-day average measurements and one month modelled data.
      $\Omega_{VC}$ shows the uncorrected vertical columns, while $\Omega_{VCC}$ shows the corrected vertical columns.
      OMI corrections shows the correction applied globally based on latitude and OMI track number(sensor).
      $\Omega_{GC}$ shows the GEOS-Chem modelled HCHO VC over the RSC, with $\Omega_{VCC}$ showing the corrected VC over the same area.
    }
    {\label{Model:omiRecalc:RSC:fig_RSCeg}}
    
    % UP TO HERE draft
    % Swath RSC corrections are done 'per track'
    For OMI swaths, each row of measured data contains 60 ``Across track''(track) measurements.
    The track index (i) relates the measurement to one of the 60 columns of data.
    Corrections (molecules cm$^{-2}$) for each measurement are calculated by taking the difference between the measured slant column and the a priori slant column as follows:
    \begin{equation} \label{Model:omiRecalc:eqn_RSC}
      Correction(i,j) = SC_{HCHO}(i,j) - VC_{GEOS-Chem}(lat(j)) \times {AMF}(i,j)
    \end{equation}
    where $j$ represents a latitude index and $VC_{GEOS-Chem}(lat)$ represents the a priori reference sector vertical column HCHO at the latitude corresponding to j.
    % Correction applied over each of the 60 tracks
    The RSC is independently calculated for each of the 60 tracks, at each latitude in the 500 0.36\degr bins.
    This provides a different RSC for each of the three AMFs.
    
    % Interpolated daily RSC to cover missing latitudes
    Due to incomplete latitudinal coverage, the correction for each track is interpolated linearly between measurements, with corrections outside of the highest measured latitudes being equal to the corrections at the highest measured latitudes.
    Figure \ref{Model:omiRecalc:RSC:fig_track_correction_interpolations} shows an example of the 60 track corrections for January 1st 2005, the points are satellite measurements longitudinally averaged over the remote pacific, coloured by track number.
    \mypicw{0.7\textwidth}{Figures/OMI_link/RSC_track_corrections20050101.png}
      {Example of track correction interpolations for January 1st 2005, points represent the difference between satellite slant column measurements and modelled slant columns over the remote pacific.}
      {\label{Model:omiRecalc:RSC:fig_track_correction_interpolations}}
    % Visualisation of RSC refering to plot and 8-day averaged corrections
    Another way to look at this correction is given in the OMI corrections panel of figure \ref{Model:omiRecalc:RSC:fig_RSCeg}, which has the sensors along the x axis, and latitude on the y axis, and shows how for this example 8-day period, the corrections are distributed with more negative values towards the left or right sensors, especially in the tropics.
    
    % One correction per pixel, based on latitude and omi track
    One correction is associated with every good satellite measurement which is used to create a reference sector corrected measurement (Vertical Column Corrected or VCC) through the following equation:
    \begin{equation}
    VCC(i,j) = \frac{SC_{HCHO}(i,j) - Correction(i,lat(j))}{AMF(i,j)}
    \end{equation}
    For each day, good satellite measurements and associated SC, VC, VCC, and AMFs are listed.
  
  \subsection{Binning the results daily}
    
    Finally the pixels are binned into a gridded dataset named OMHCHORP, as shown in figure \ref{Model:omiRecalc:fig_flow_omhchorp}.
    The resolution is chosen to match the native resolution of GEOS-Chem (0.25x0.3125\degr) and the GEOS met data fields.
    A bin entry count is used to allow easy rebinning, and can be used to check for sparse data days due to filtering or poor weather.
    Data averaged into this dataset are as follows:
    \begin{enumerate}
      \item satellite SC %($\Omega_{S}$)
      \item satellite AMF %(AMF$_{OMI}$)
      \item satellite VC %($\Omega_{V,OMI}$
      \item satellite RSC VC %($\Omega_{VC,OMI}$)
      \item GEOS-Chem recalculated AMF %(AMF$_{GC}$)
      \item GEOS-Chem recalculated VC %($\Omega_{V,GC}$)
      \item GEOS-Chem recalculated RSC VC %
      \item GEOS-Chem AMF recalculated using Paul Palmer code (AMF$_{PP}$)
      \item GEOS-Chem RSC VC based on AMF$_{PP}$
      \item Smoke AAOD from OMAERUVd (mapped into bins from 1x1\degr resolution)
      \item satellite pixel counts (summed into bins)
      \item fire counts (summed into bins)
    \end{enumerate}
    
    This whole process requires some processing time as well as RAM and computer storage space, and has been performed on the National Computing Infrastructure (NCI) supercomputer cluster.
    In order to reprocess one year of swath files, $\sim 162$~GB ($142 + 16 + 4$ OMHCHO, MOD14A1, and OMNO2d respectively) of daily data was downloaded and then transformed into $\sim 8$~GB (per year) of daily gridded data.
    This takes around 90 minutes per day, and is very parallelisable as each day is completely independent once the model has run in each required configuration.
    Initially parallelism was built into the python code, however simply sending separate jobs to NCI's process queue was simpler and more scalable.
    As much as possible, processing is done using the HDF-5 or NetCDF-4 formats, with some GEOS-Chem output being read from bitpunch.
    The scripts to regrid and reprocess the swath data set are available from github at TODO.
  
  \subsection{Difference between new and old OMI HCHO columns}
  
    
    New corrected vertical columns (VCC) of HCHO are created at global 0.25 by 0.3125\degr horizontal resolution.
    These calculations are compared over Australia in figure(s) \ref{Model:omiRecalc:diff:fig_vcc_comparison}, TODO: regression, and time series.
    Figure \ref{Model:omiRecalc:diff:fig_vcc_comparison} shows how the recalculated columns compare to the original (OMI, left). 
    Recalculation increases the January column amounts while also slightly flattening the distributions (row 3).
    The effect of not recalculating the $\omega_z$ can also be seen in figure \ref{Model:omiRecalc:fig_VCC_pp_fires} which shows the altered satellite vertical columns using each method.
    
    % Fire filtering affect split over recalculations
    Figure \ref{Model:omiRecalc:fig_VCC_pp_fires} shows vertical columns of HCHO for: column 1) the original satellite swaths, column 2) recalculated without changing the provided scattering weights, and column 3) fully recalculated vertical columns. 
    Each grid square (at 0.25 by 0.3125\degr resolution) has been created by binning the recalculated satellite pixels within the month.
    The average number of pixels per land square is inset as text, changing due to how the fire filter is applied.
    Each row has a stricter fire filter applied from top to bottom, with no fire filter on the first row up to filtering pixels from squares with fires up to 8 days prior.
    This figure looks at March 2005 with biomass burning filtered differently in each row.
    Active fires over the last 0, 1, 2, 4, and 8 days are filtered as the row number increases.
    
    % Figure showing VCC omi, gc, and pp, and distribution
    % produced in tests.py -> check_products()
    \mypic{Figures/OMI_link/VCC_check_200501.png}{%
      Row 1: regridded corrected $\Omega_{HCHO}$ from OMHCHO on January 1, 2005: original (left), recalculated using new shape factors (middle), and additionally using updated scattering weights (right).
      Row 2: shows the monthly average for January 2005.
      Row 3: shows the distribution over the month for each of the three column amounts.}{\label{Model:omiRecalc:diff:fig_vcc_comparison}}
    
    %TODO: figure analysing amf vs amf_gc vs amf_pp
    Figure TODO shows an analysis of the differences between running the recalculation with and without updating the $\omega_z$.
    
    \mypic{Figures/OMI_link/VCC_fires_20050301-20050331.png}{% 
      Column 1: Reference sector corrected HCHO vertical columns $\Omega$ from OMHCHOv003.
      Column 2: $\Omega$ with recalculated a priori shape factors using GEOS-Chem v10.01.
      Column 3: $\Omega$ with recalculated a priori shape factors and scattering weights using GEOS-Chem v10.01 and LIDORT.
      Row 1-5: increasing number of prior days which have active fires are included when masking fire influence.
      }{\label{Model:omiRecalc:fig_VCC_pp_fires}}
    
    TODO: compare how many nans from palmers code to my code
    The AMF calculated using professor Palmer's produces TODO: MORE OR FEWER reasonable (within screening range of -5$\times 10^{15}$ to 1$\times 10^{17}$) vertical column amounts.
    Stricter filtering must be balanced against both coverage and the sensitivity of the AMF determination to recalculating $\omega_z$.
  
    Figure TODO: shows global and Australian HCHO averaged total column maps for January 2005, along with the reduced major axis (RMA) regression correlation and percentage difference.
    This comparison shows how reprocessing with an updated model can have a systematic influence on the total column.
    
\section{Filtering Data}
  \label{Model:Filter}
  
  % Why filter data
  In order to examine only biogenic processes, pyrogenic and anthropogenic influences need to be removed from modelled and measured data.
  Biomass burning can be a large local or transported (via smoke plumes) source of HCHO, CHOCHO, glyoxal, and other compounds which influence levels of both HCHO and isoprene.
  Anthropogenic emissions from power generation, transport, and agriculture can influence these levels as well.
  Where possible these influences need to be removed so that calculations of purely biogenic emissions are not biased. 
  In GEOS-Chem we can simply turn off pyrogenic and anthropogenic emissions, however in satellite datasets we need to mask potentially affected pixels.
  
  % How other people have filtered fires
  Influence from biomass burning can be removed through measurements of acetonitrile and CO \parencite[e.g.,][]{Wolfe2016, Miller2017}, or else removal of scenes coincident with satellite detected fire counts and aerosol absorption optical depth as done in \textcite{Marais2014}.
  \textcite{Marais2012} remove pixels colocated with non zero fire counts in any of the prior eight days, within grid squares with 1 x 1\degr resolution.
  \textcite{Barkley2013} use fires from the preceding and concurrent day, within local or adjacent grid squares, with grid resolution of 0.25 x 0.3125\degr.
  \textcite{Wolfe2016} disregard HCHO measurements when acetonitrile > 210~pptv and CO > 300~ppbv, while acetonitrile > 200~pptv is used to determine fire influence in \textcite{Miller2017}.
  TODO: look at yearly correlation, compare to exponential curve and look for fire outliers
  As seen in TODO: citation, HCHO concentrations scale exponentially with temperature.
  This allows another method for detecting the influence of non-biogenic HCHO emission/creation by looking for outliers above the curve at low temperature.
  \textcite{Zhu2013_poster} has a similar analysis over south-eastern USA showing an exponential correlation of ${HCHO} = \exp(0.15\times{T}-9.07)$.
  
  I use satellite data to account for anthropogenic and pyrogenic influences on the OMHCHO satellite HCHO columns.
  MODIS fire counts are used in conjunction with smoke AAOD enhancements (from OMI) to remove data points which may be affected by fires or fire smoke plumes.
  OMI NO$_2$ measurements are used to mask potential anthropogenic influence.  
  These masks negatively affect uncertainty,  as fewer measurements are available to be averaged.
  This section describes the creation and effects of filters used on satellite data.
  
  A quick summary of how much data is filtered over Australian land squares is provided in table \ref{Model:Filter:tab_summary_pixels_masked}, and an quick check of how many pixels are filtered in January 2006 can be seen in Figure \ref{Model:Filter:fig_pixel_loss_Jan06}.
  The anthropogenic filter completely removes grid squares over Sydney and Melbourne, and high removal rates over Brisbane. 
  Other major cities in Australia either do not emit enough NO$_2$ or are too spread out and do not breach the threshold to be filtered as anthropogenic.
  
  %TODO: Rerun the calculation after changing fire filter
  \begin{table}
    % This table can be generated by test_filters.summary_pixels_filtered()
    \caption{How many satellite pixels are filtered by pyrogenic and anthropogenic masking. Left to right the columns display year, how many land pixels are read over Australia, how many of these pixels are removed by the pyrogenic filter, how many are removed by the anthropogenic filter, and how many are removed in total. In parenthesis are the portion of pixels filtered.}
    \begin{tabular}{ c c c c c }
      \textbf{Year} & \textbf{Pixels} & \textbf{Pyro} & \textbf{Anthro} & \textbf{Total} 
      \\ \hline
      2005   &  3.9e+06    &  4.1e+05(10.7\%)     &    5.0e+04( 1.3\%)    &    4.4e+05(11.5\%) \\
      2006   &  3.8e+06    &  5.1e+05(13.5\%)     &    9.2e+04( 2.4\%)    &    5.6e+05(14.7\%) \\
      2007   &  3.7e+06    &  4.4e+05(11.9\%)     &    7.5e+04( 2.0\%)    &    4.9e+05(13.0\%) \\
      TODO &  &  &  \\
      TODO &  &  &  \\
    \end{tabular}
    \label{Model:Filter:tab_summary_pixels_masked}
  \end{table}
  
  \mypic{Figures/OMI_link/Filters/PixelsFiltered_20060101-20060131.png}{Top row shows grid squares filtered out by pyrogenic(left) and anthropogenic(right) influence masks during January 2006. Along the bottom is the time series of total pixels over Australian land squares with and without filtering the data.}{\label{Model:Filter:fig_pixel_loss_Jan06}}
  
  
  \subsection{Fire and smoke}
    \label{Model:Filter:fire}
    
    
    The method used in this thesis follows that of \textcite{Marais2012}, and \textcite{Barkley2013}, with active fires filtered using fire counts, and smoke filtered out using smoke AAOD.
    We use the MODIS fire counts, detected from space using the combined product from Terra and Aqua (Terra at 10:30, 22:30 LT; Aqua at 13:30, 01:30 LT).
    Smoke plumes are filtered using smoke AAOD from product OMAERUVd, with the threshold determined through analysis of Australian AAOD distributions.
    
    % My method for fire filtering:
    OMHCHO total column HCHO $\Omega$ is processed into a 0.25x0.3125\degr horizontal daily grid.
    Pyrogenic filters are interpolated to the same horizontal resolution as $\Omega$ to simplify application. 
    The following steps are performed in order to create the pyrogenic influence mask:
    \begin{enumerate}
      \item MOD14A1 daily gridded Aqua/Terra combined fire counts (1x1~km$^2$) are read, and binned into 0.25x0.3125\degr bins (matching the resolution of binned $\Omega$).
      \item A rolling mask is formed which removes $\Omega$ if one or more fires are detected in a grid square, or in the adjacent grid square, up to 2 days previously.
      This includes the current day, making 3 days of fires in total being filtered out on each day.
      \item AAOD at 500~nm is mapped from OMAERUVd (1x1\degr resolution) onto the 0.25x0.3125\degr resolution.
      \item An AAOD threshold of 0.03 is determined through visual analysis of AAOD distributions over several days, including days with and without influence from active fires, dust, and transported smoke plumes (see figure \ref{Model:Filter:fire:fig_typicalAAOD}).
      \item Grid squares with AAOD over this threshhold are considered potentially affected by transported fire smoke.
    \end{enumerate}
  
    % Smoke AAOD filtering:
    Determining the AAOD due to smoke can be difficult since both smoke and dust absorb UV radiation \parencite{Ahn2008,Marais2012}.
    AAOD is less sensitive to cloud contamination than AOD, and I use AAOD from the daily gridded level 3 satellite product OMAERUVd \parencite{Ahn2008} described in section \ref{Model:Datasets:OMAERUVd} to provide a filter for smoke plumes.
    Although removing gridsquares with dust reduces how much data is available to analyse, dust in Australia is highly episodic and should not affect more than a few days per year, especially over regions with high tree coverage \parencite{Shao2007}.
    
    % Threshold for AAOD determination
    Filtering fire smoke using AAOD is done by removing OMHCHO gridsquares where the AAOD is above a 0.03, after the AAOD is mapped from 1x1\degr to the same 0.25x0.3125\degr resolution as our OMHCHO gridded product.
    The threshhold is determined through analysing AAOD over Australia in 4 scenarios: normal conditions, active local fires, during influence from transported fire smoke, and large scale dust storms.
    Figure \ref{Model:Filter:fire:fig_typicalAAOD} shows AAOD (columns 1 and 2), with AAOD distribution in column 3, along with satellite imagery on the same day in column 4 (from \url{https://worldview.earthdata.nasa.gov/}).
    The scenarios listed are shown from row 1 to 4, and AAOD $=$ 0.03 is demarked by a horizontal line in the density plots in column 3.
    Figure \ref{Model:Filter:fire:fig_smokefilter} shows how the smoke filter compares to the fire filter over 2005.
    The left panel shows how many days are filtered using the AAOD threshhold, while the right panel shows how many are filtered using the combined smoke and active fire masks.
    The time series shows pixels available for analysis before being filtered (black), after smoke filtering (cyan) and after the full fire filter is applied (magenta).
    The Ayre basin is the dominant area filtered by smoke detection, likely due to dust influence in the arid region.
    
    \mypic{Figures/OMI_link/typical_AAODs.png}
      {AAOD from OMAERUVd (columns 1, 2, 3) over Australia for four different scenarios (rows 1-4). Scenes from the same day are taken from the EOS Worldview website \url{https://worldview.earthdata.nasa.gov/}.}
      {\label{Model:Filter:fire:fig_typicalAAOD}}
    
    \mypic{Figures/OMI_link/Filters/SmokeFilter_20050101-20051231.png}{Smoke (top left) filtered days using AAOD$>0.03$ compared to the combined (smoke and active fires) fire filter (top left). Time series shows how many pixels are available for analysis before and after filtering.}{\label{Model:Filter:fire:fig_smokefilter}}
    
    %
    Figure \ref{Model:Filter:fire:fig_portion_filtered_2005} shows what portion of pixels are filtered out by the pyrogenic filter. 
    The top panel shows the spatial distribution of fire masks, with most pixels removed along the northern and eastern coastlines.
    A large portion of the filtered areas appear to correspond with forested areas (see figure \ref{Model:Filter:fire:fig_forest_coverage}), which suggests that forest fires are being masked properly.
    Central Australia is largely unmasked, which could be due to a lack of sufficient vegetation to create a large enough fire to be seen by satellite.
    %Even though transported smoke plumes from South America and southern Africa would influence the measurements in the area.
    The other potential cause of pyrogenic filtering is the proliferation of petrol or gas wells (see figure \ref{Model:Filter:fire:fig_petrol_wells} and figure \ref{Model:Filter:fire:fig_gas_lands}).
    The filtering shown here is for 2005, when 388 gas wells existed in Queensland, however more than 2000 wells (cumulative) were approved by 2013, so this may cause more filtering over the course of this thesis' timeline \parencite{Carlisle2012}.
    To check this the filtering portion for 2012 is also plotted in Figure TODO: plot map of filtered squares for 2012 when it has been run by NCI.
    One clear hotspot is located over port Kembla (south of Sydney), most likely due to the flame which burns over the blast furnace stack throughout the year.
    Another hotspot can be seen in Western Australia over Kalgoorlie, where a large open cut gold mine ``super pit'' is always open and blasting daily.
    In Western Queensland over Mount Isa there is again a mining related hotspot.
    A large area in southern Queensland/northern NSW is also heavily filtered, potentially due to gas flaring in the Surat Basin, which has thousands of petrol and gas wells.
    
    
    \mypic{Figures/OMI_link/Filters/Pyrogenic_filter_annotated_2.png}
    {Top: Portion of 2005 filtered out by fire and smoke masks. Bottom: portion filtered out each day from land squares in Australia.}{\ref{Model:Filter:fire:fig_portion_filtered_2005}}
    
    \mypic{Figures/Wells_AUS.png}{Petrol Well locations over Australia (current-2018) (\url{http://dbforms.ga.gov.au/www/npm.well.search})}{\label{Model:Filter:fire:fig_petrol_wells}}
    
    \mypic{Figures/Gas_AUS.jpg}{Gas fields and pipelines (2018) for Australia (\url{http://www.ga.gov.au/scientific-topics/energy/resources/petroleum-resources/gas})}{\label{Model:Filter:fire:fig_gas_lands}}
    
    \mypic{Figures/Australiasforests_2016.png}{Forest coverage, coloured by predominant tree species.}{\ref{Model:Filter:fire:fig_forest_coverage}}
  
    \subsubsection{Checking that fire masks are influencing pyrogenic HCHO}
      
      Looking at temperature can provide evidence of pyrogenic HCHO.
      HCHO precursors are heavily tied to temperature (TODO:cite), and model output shows how higher temperature leads to an increase in HCHO levels.
      Figures \ref{Model:Analysis:HCHO:fig_hcho_vs_temp_SEA_200501} - \ref{Model:Analysis:HCHO:fig_hcho_vs_temp_SWA_200501} show the relationship between modelled temperature, and satellite HCHO for January 2005 within subsets of Australia.
      A reduced major axis regression is used to determine the correlation between surface temperature (X axis) and HCHO (Y axis).
      Using the natural log of HCHO we can take the linear regression and then exponentiate each side in the equation $\ln{Y} = m{X}+b$ to get ${Y} = \exp{m{X}+b}$. 
      This gives us the exponential fit as shown, with the correlation coefficient between $\ln{HCHO}$ and temperature.
      The distributions of exponential correlation coefficients and $m$ terms is shown in the embedded plot, with one datapoint available for each grid square where the regression is performed.
      
      Figures \ref{Model:Filter:fire:fig_HCHO_vs_GC_temperature} and \ref{Model:Filter:fire:fig_HCHO_vs_CPC} show the regressions between OMI HCHO total columns and temperature from GEOS-Chem output and CPC daily maximum temperatures respectively.
      Comparing against GEOS-Chem modelled surface temperatures first requires deresolution from 0.25x0.3125 to 2x2.5\degr latitude by longitude resolution.
      The left column in figure \ref{Model:Filter:fire:fig_HCHO_vs_GC_temperature} shows scatter and RMA correlation within a single gridbox over 2 months from Jan 1 to Feb 28, 2005, without having applied either the fire nor anthropogenic masks to OMI HCHO columns. 
      The right column shows the same correlation after applying the fire filter, affected datapoints are marked in teal (matching the red marked points in the left column).
      The analysis is repeated for Sydney, Canberra, and three gridsquares to the north-west, west, and southwest of Sydney (w1, w2, w3 respectively).
      Figure \ref{Model:Filter:fire:fig_HCHO_vs_CPC} shows the same analysis at higher resolution using CPC daily maximum temperatures (see \ref{Model:Datasets}).
      
      \mypic{Figures/OMI_link/Filters/HCHO_vs_temp_20050101-20050228.png}{HCHO vs GEOS-Chem daily midday temperatures TODO add longer caption}{\label{Model:Filter:fire:fig_HCHO_vs_GC_temperature}}
      
      \mypic{Figures/OMI_link/Filters/HCHO_vs_CPCtemp_20050101-20050228.png}{HCHO vs CPC daily maximum temperatures TODO add longer caption}{\label{Model:Filter:fire:fig_HCHO_vs_CPC}}
      
      
      One cause of high HCHO at lower temperatures is direct or transported emissions and subsequent products from biomass burning.
      One potential problem with showing this is that days with fire enhanced HCHO are also likely to be hot.
      Another problem with correlating heat and HCHO is that increased temperature accelerates HCHO destruction \parencite{Zheng2015}.
      We test the fire mask by examining the relationship between modelled temperature and satellite HCHO with and without applying the filters for smoke and active fires.
      Figures TODO-TODO show the exponential fits for one month of datapoints (January 2005) in Northern, Southeastern, and Southwestern Australia respectively.
      Each grid square (2 by 2.5\degr) provides one datapoint per day, with satellite HCHO initially averaged onto the lower resolution of the GEOS-Chem modelled surface (from 0 to $\sim 100$~m) temperature
      The scatter between HCHO and temperature is coloured by fire counts, and we see TODO.
      The TODO lines show the exponential fit before and after filtering fire and smoke.
      TODO plot showing how fire mask affects HCHO - Temperature relationship
      
      
      \begin{figure}
        % Figure produced in test_filters 
        \includegraphics[width=\textwidth]{Figures/OMI_link/GC/HCHO_vs_temp_SEA_20050101-20050228.png}
        \caption{%
          Top panel: surface temperature averaged over January and February 2005.
          Bottom panel: surface temperature correlated against temperature over, with different colours for each gridbox, and the combined correlation. 
          A reduced major axis regression is used within each gridbox (shown in top panel) using daily overpass time surface temperature and HCHO amounts (ppbv).
          The distribution of slopes and regression correlation coefficients (one datapoint per gridbox) for the exponential regression is shown in the embedded plot.
          }
        \label{Model:Analysis:HCHO:fig_hcho_vs_temp_SEA_200501}
        \end{figure}
          
        \begin{figure}
          \includegraphics[width=\textwidth]{Figures/OMI_link/GC/HCHO_vs_temp_NA_20050101-20050228.png}
          \caption{%
            As figure \ref{Model:Analysis:HCHO:fig_hcho_vs_temp_SEA_200501} but for northern Australia.
            }
          \label{Model:Analysis:HCHO:fig_hcho_vs_temp_NA_200501}
        \end{figure}
          
        \begin{figure}
          \includegraphics[width=\textwidth]{Figures/OMI_link/GC/HCHO_vs_temp_SWA_20050101-20050228.png}
          \caption{%
            As figure \ref{Model:Analysis:HCHO:fig_hcho_vs_temp_SEA_200501} but for south-western Australia.
            }
          \label{Model:Analysis:HCHO:fig_hcho_vs_temp_SWA_200501}
        \end{figure}
  
  \subsection{NOx}
    \label{Model:Filter:NOx}
    
    % Why filter high NO? Anthro influence
    Enhanced NO$_2$ concentrations can indicate anthropogenic influence over Australia.
    In order to filter out these influences on satellite HCHO measurements, a filter is designed using the OMNO2d product which includes tropospheric NO$_2$ columns.
    
    % Nox analysis from OMNO2d
    OMNO2d from 2005 is used to determine a suitable threshhold for anthropogenic influence by looking at NO$_2$ columns near several major cities in the south eastern sector of Australia.
    The mean, standard deviation, and time series over Australia of tropospheric NO$_2$ seen by Aura is shown in figure \ref{Model:Filter:NOx:fig_omno2_timeseries}.
    The average tropospheric NO$_2$ column averaged within all of Australia and then each region shown in this figure is listed in table TODO \ref{Model:Filter:NOx:tab_summary}.
    
    \mypic{Figures/OMI_link/OMNO2_timeseries_2005.png}
    {Mean (top left) and standard deviation (top right) of OMNO2d daily 0.25x0.25\degr tropospheric cloud filtered NO$_2$ columns. Time series for Australia, and each region (by colour) shown in the bottom panel, with mean for that region shown on the right. A grey shaded area depicts the 25th to 75th percentiles of Australia averaged NO$_2$ columns for each day in the time series, with a thicker black line showing the Australia-wide mean value.}
    {\label{Model:Filter:NOx:fig_omno2_timeseries}}
    
    % Filters and Threshhold determination and reasoning
    Anthropogenic influences on the NO$_2$ columns are clearly visible near major cities in Australia.
    A filter is created each year from the OMNO2d product in two steps:
    \begin{enumerate}
      \item Daily gridsquares with NO$_2$ greater than 10$^{15}$\moleccm  are flagged as anthropogenic.
      \item After taking the yearly average over Australia, any gridsquares greater than $1.5 \times 10^{15}$\moleccm are flagged for the whole year.
    \end{enumerate}
    This removes both the gridsquares close enough to cities to be affected by their emissions year round, as well as effects from transported pollution plumes.
    The affects of applying this filter to the OMNO2d product itself can be seen in figure \ref{Model:Filter:NOx:fig_omno2_threshaffect}
    
    \mypic{Figures/OMI_link/OMNO2_threshaffect_2005.png}
    {2005 OMNO2d NO$_2$ column mean before (left) and after (right) applying the threshhold filters as described in the text. Time series for Australia, and each region (by colour) shown in the bottom panel, with mean for that region shown on the right.}
    {\label{Model:Filter:NOx:fig_omno2_threshaffect}}
    
    % Threshhold analysis
    The same regions as in figure \ref{Model:Filter:NOx:fig_omno2_timeseries} are shown again in figure \ref{Model:Filter:NOx:fig_omno2_densities}, with NO$_2$ pixels densities for each region shown, along with the threshold of $1 \times 10^{15}$\moleccm.
    This led to a reduction of TODO gridsquares from the total available measurement space over Australia.
    The removal of gridsquares which went above the yearly averaged limit of 1.5e15\moleccm further reduced the available data by TODO gridsquares.
    
    \mypic{Figures/OMI_link/OMNO2_densities_2005.png}
    {2005 OMNO2d NO$_2$ column means (top left), along with column amount distributions for Australia (top right) and each region shown in the area map (by colour)}
    {\label{Model:Filter:NOx:fig_omno2_densities}}
    
    \begin{table}
      \caption{NO$_2$ averages by region before and after filtering for anthropogenic emissions using 2005 data from the OMNO2d product.}
      \begin{tabular}{ c c c c }
        \hline
        \textbf{Region} & \textbf{NO$_2$} & \textbf{NO$_2$ after filtering} & \textbf{\% Data lost} 
        \\ \hline
        Aus & 1 & 2 & 3 \\
        BG & 1 & 2 & 3 \\
        Syd & 1 & 2 & 3 \\
        Melb & 1 & 2 & 3 \\
        Adel & 1 & 2 & 3 \\
        \hline
      \end{tabular}
      \label{Model:Filter:NOx:tab_summary}
    \end{table}
    
    % Affects of filtering
    % TODO: tabulate or summarise no2 filtering
      
     
\section{Data Access}
TODO: ADD MORE HERE
\label{Model:DataAccess}
\begin{description}
  \item[OMHCHO] Satellite swaths of HCHO slant columns downloaded from \url{https://search.earthdata.nasa.gov}, with DOI 10.5067/Aura/OMI/DATA2015
  
  \item[OMNO2d] Daily satellite NO$_2$ product downloaded from \url{https://search.earthdata.nasa.gov/search}, DOI:10.5067/Aura/OMI/DATA3007. 
  For more information in refer to section %TODO:
  
  \item[OMAERUVd] Gridded satellite based AAOD measurements downloaded from \url{https://search.earthdata.nasa.gov}, DOI 10.5067/Aura/OMI/DATA3003. %TODO cite Omar O. Torres (2008), OMI/Aura Near UV Aerosol Optical Depth and Single Scattering Albedo L3 
  
  \item[SPEI] Monthly standardised precipitation evapotranspiration index (metric to determine drought stress) downloaded from \url{http://hdl.handle.net/10261/153475} with DOI:10.20350/digitalCSIC/8508.
  See more information in section %TODO:
  
  
  
\end{description}